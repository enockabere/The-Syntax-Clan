{% extends 'base.html' %}
{% load static %}
{% block base %}

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<section class="section">
    <div class="section-header">
        <h1>Payment Gateway</h1>
        <div class="section-header-breadcrumb">
            <div class="breadcrumb-item active"><a href="{% url 'dashboard' %}">Dashboard</a></div>
            <div class="breadcrumb-item">Payment Gateway</div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            {% include 'alert.html' %}
            <div class="card mt-2">
                <div class="card-body">
                    <div class="row m-0">
                        <div class="col-md-6 col-12">
                            <div class="row">
                                <div class="col-12 mb-4">
                                    <div class="row box-right">
                                        <div class="col-md-8 ps-0 ">
                                            <p class="ps-3 textmuted fw-bold h6 mb-0"><span
                                                    class="bi bi-circle-fill pe-2" style="color:#0e5a8d;"></span> Total
                                                to Pay</p>
                                            <p class="h1 fw-bold d-flex"> <span
                                                    class="bi bi-cash-stack textmuted pe-1 h6 align-text-top mt-1"></span>
                                                {{res.Currency_Code}} {{res.Amount_Payable}}
                                            </p>
                                        </div>
                                        <div class="col-md-4">
                                        </div>
                                        <div class="money-spinner mx-auto text-center" id="spinner6"
                                            style="display: none;">
                                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                alt="Loading Gif" style="height: 70px; width: 100px;" class="img-fluid">
                                        </div>

                                        <form id="processPayment" class="mt-3" method="POST">
                                            {% csrf_token %}
                                            <input type="hidden" name="Veterinary_Classes" id="Veterinary_Classes"
                                                value="{{res.Veterinary_Classes}}">
                                            <input type="hidden" name="Process" id="Process" value="REGISTRATION">
                                            <input type="hidden" name="Types_Of_Manufacturers"
                                                id="Types_Of_Manufacturers" value="{{res.Types_Of_Manufacturers}}">
                                            <input type="hidden" name="bill_desc" id="bill_desc"
                                                value="{{res.Productname}}">
                                            <input type="hidden" name="currency" id="bill_currency"
                                                value="{{res.Currency_Code}}">
                                            <input type="hidden" name="bill_ref_number" id="bill_ref_number"
                                                value="{{res.ProductNo}}">
                                            <input type="hidden" name="client_name" id="client_name"
                                                value="{{res.Name_of_the_Applicant_}}">
                                            <input type="hidden" name="amount_expected" id="amount_expected"
                                                value="{{res.Amount_Payable}}">
                                            <button type="submit" class="btn btn-primary d-block w-100"> Process Payment
                                                <span class="ms-3 bi bi-arrow-right"></span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- id="processPayment" -->
                        <div class="col-md-6 col-12 ps-md-5 p-0 ">
                            <div class="box-left">
                                <div class="">
                                    <p class="h7 fw-bold mb-1">Make Payments</p>
                                    <p class="textmuted h8 mb-2">Choose from the payment options available to proceed.
                                        Your payment
                                        will be processed
                                        immediately.
                                    </p>
                                    <form action="{% url 'FNGenerateInvoice' res.ProductNo %}" method="post">
                                        {% csrf_token %}
                                        <button type='submit' class="btn btn-info w-100 my-3">Preview Invoice</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    $(document).ready(function () {

        const $processPayment = $('#processPayment');

        $processPayment.on('submit', (e) => {
            e.preventDefault();
            $("#spinner6").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/PesaflowPaymentView/',
                data: {
                    bill_desc: $('#bill_desc').val(),
                    currency: $('#bill_currency').val(),
                    bill_ref_number: $('#bill_ref_number').val(),
                    client_name: $('#client_name').val(),
                    amount_expected: $('#amount_expected').val(),
                    Veterinary_Classes: $('#Veterinary_Classes').val(),
                    Types_Of_Manufacturers: $('#Types_Of_Manufacturers').val(),
                    Process: $('#Process').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {

                    console.log(response)
                    const invoiceLink = response.response_data.invoice_link;

                    window.open(invoiceLink);

                    $("#spinner6").hide();
                },
                error: function (error) {
                    console.log(error);
                    $("#spinner6").hide();
                }
            });
        });
    })
</script>

{% endblock %}