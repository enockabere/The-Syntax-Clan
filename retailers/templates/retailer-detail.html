{% extends 'base.html' %}
{% load static %}
{% block base %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="{% static 'plugins/Moment/moment.js' %}"></script>
<link rel="stylesheet"
    href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
<section class="section">
    <div class="section-header">
        <h1>Retail Veterinary Pharmacy Permit Application</h1>
        <div class="section-header-breadcrumb">
            <div class="breadcrumb-item active"><a href="{% url 'dashboard' %}">Dashboard</a></div>
            <div class="breadcrumb-item">New Applications</div>
        </div>
    </div>
    <div class="section-body">
        <div class="row" id="ApplicationRow">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4 id="other_professionals">Other Professionals Working in the Pharmacy</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div id="stepTwo" class="bg-white p-4" style="display: none">
                                    <div class="border border-success rounded p-3  my-3">
                                        <div class="premise_data" id="premise_data">
                                            <div class="money-spinner mx-auto text-center" id="spinner2"
                                                style="display: none;">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                    alt="Loading Gif" style="height: 70px; width: 100px;"
                                                    class="img-fluid">
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center my-3">
                                                <button class="btn btn-primary" id="addRetailLine"><i
                                                        class="las la-plus"></i>
                                                    Add
                                                    Line</button>
                                            </div>
                                            <div class="table-responsive">
                                                <table id="ProfessionalsTable"
                                                    class="table w-100 table-striped dt-responsive table-responsive-lg table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th>Name</th>
                                                            <th>Pro Reg No.</th>
                                                            <th>Nationality</th>
                                                            <th>ID/Passport/Alien ID No.</th>
                                                            <th>Position</th>
                                                            <th>Qualification</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <form method="POST" id="ProfessionalsForm" style="display: none;">
                                                {% csrf_token %}
                                                <p class="text-small text-primary"> Professionals Working in the
                                                    premise</p>
                                                <input type="hidden" name="myAction" id="Professionals_my_action"
                                                    value="insert">
                                                <input type="hidden" name="lineNo" id="Professionals_lineNo" value="">
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <label class="form-label">Full Name <span
                                                                class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" name="pro_name"
                                                            id="pro_name" required>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">Professional Reg No. </label>
                                                        <input type="text" class="form-control" name="professionalRegNo"
                                                            id="professionalRegNo" required>
                                                    </div>
                                                </div>
                                                <div class="row my-3">
                                                    <div class="col-md-4">
                                                        <label class="form-label">Nationality <span
                                                                class="text-danger">*</span></label>
                                                        <select class="form-control" aria-label="Default select example"
                                                            name="nationality" id="nationality">
                                                            <option selected disabled value="0">Choose...</option>
                                                            {% for res in country %}
                                                            <option value="{{res.Code}}">{{res.Name}}</option>
                                                            {% empty %}
                                                            <option value="KE">KENYA</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">ID/Passport/Alien ID No <span
                                                                class="text-danger">*</span></label>
                                                        <input type="text" class="form-control"
                                                            name="iDorPassportOrAlienIDNo" id="iDorPassportOrAlienIDNo">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">Position in the Business<span
                                                                class="text-danger">*</span></label>
                                                        <input type="text" class="form-control"
                                                            name="position_in_business" id="position_in_business"
                                                            required>
                                                    </div>
                                                </div>
                                                <div class="row my-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Qualification<span
                                                                class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" name="Qualification"
                                                            id="Qualification" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Experience<span
                                                                class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" name="Experience"
                                                            id="Experience" required>
                                                    </div>
                                                </div>
                                                <div class="money-spinner mx-auto text-center" id="spinner1"
                                                    style="display: none;">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                        alt="Loading Gif" style="height: 100px; width: 100px;"
                                                        class="img-fluid">
                                                </div>
                                                <div class="d-flex gap-3">
                                                    <button type="submit" id='submit_line'
                                                        class="btn btn-primary mr-1 my-2 w-100">Save
                                                        Line</button>
                                                    <button type="button" class="btn btn-info my-2 ml-1 w-50"
                                                        id="hideRetailLine">
                                                        <i class="las la-eye"></i> View
                                                        Lines</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="w-100">
                                        <div id="Professionals_btn" style="margin: auto; width: fit-content;">
                                            <button class="btn btn-warning" id="ProfessionalsNext">Next Step <i
                                                    class="las la-angle-double-right"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="stepThree" id="stepThree" style="display: none">
                                    <div class="m-0 bg-white p-4">
                                        <div class="Attachment_data w-100" id="Attachment_data">
                                            <div class="money-spinner mx-auto text-center" id="spinner3"
                                                style="display: none;">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                    alt="Loading Gif" style="height: 70px; width: 100px;"
                                                    class="img-fluid">
                                            </div>
                                            <h2 class="section-title">Attachment</h2>
                                            <form method="POST" id="attachmentForm">
                                                {% csrf_token %}
                                                <input type="hidden" name="myAction" id="Professionals_my_action"
                                                    value="insert">
                                                <input type="hidden" name="lineNo" id="Professionals_lineNo" value="">
                                                <div class="row my-2">
                                                    <div class="col-md-12">
                                                        <div class="form-group" id="attachmentCodeRow">
                                                            <label class="form-label">Select Document to Upload<span
                                                                    class="text-danger">*</span></label>
                                                            <select class="form-control"
                                                                aria-label="Default select example"
                                                                name="attachmentCode" id="attachmentCode">
                                                                <option class="after" value="" disabled>--Select--
                                                                </option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="mb-2">
                                                            <label class="form-label">Upload Attachment <span
                                                                    class="text-danger">*</span></label>
                                                            <input type="file" class="form-control" name="attachments"
                                                                id="attachments" accept=".pdf">
                                                        </div>
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary my-2 w-100">Upload</button>
                                            </form>
                                            <div id="AttachmentsBtns" style="width: fit-content; margin: auto;">
                                                <button class="btn btn-secondary" id="AttachmentsPrev"><i
                                                        class="las la-angle-double-left"></i> Prev
                                                    Step</button>
                                                <button class="btn btn-warning" id="AttachmentsNext"
                                                    style="display: none;">Next
                                                    Step <i class="las la-angle-double-right"></i></button>
                                            </div>
                                        </div>
                                        <div class="row my-3" id="attachments-container">

                                        </div>
                                    </div>
                                </div>
                                <div class="stepFour" id="stepFour" style="display: none">
                                    <div class="row m-0">
                                        <div class="col-md-12 bg-white my-2">
                                            <div class="d-flex justify-content-end align-items-center my-3">
                                                <div class="money-spinner mx-auto text-center" id="spinner4"
                                                    style="display: none;">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                        alt="Loading Gif" style="height: 70px; width: 100px;"
                                                        class="img-fluid">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div id="pdfContainer" style="min-height: 600px">
                                                <!-- The PDF will be displayed here -->
                                            </div>
                                            <div class="row box-right">
                                                <div class="col-md-8 ps-0 ">
                                                    <h4 class="my-3"><span id="payment_state" class="text-warning">Total
                                                            to Pay </span></h4>
                                                    <p class="h1 fw-bold d-flex"> <span
                                                            class="las la-coins textmuted pe-1 h6 align-text-top mt-2"></span>
                                                        <span class="pesa_paid">{{permit.Currency}}
                                                            {{permit.AmountPayable}}</span>
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="money-spinner mx-auto text-center" id="spinner6"
                                                style="display: none;">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                    alt="Loading Gif" style="height: 70px; width: 100px;"
                                                    class="img-fluid">
                                            </div>
                                            <hr>

                                            <div class="text-md-right">
                                                <div class="float-lg-left mb-lg-0 mb-3">
                                                    <button class="btn btn-secondary btn-icon icon-left"
                                                        id="paymentPrev"><i class="las la-angle-double-left"></i>
                                                        Prev
                                                        Step</button>
                                                    <form method="post" id="payment_submit_form" style="display:none">
                                                        {% csrf_token %}
                                                        <button class="btn btn-warning btn-icon icon-left"
                                                            id="payment_submit">Submit
                                                        </button>
                                                    </form>
                                                </div>
                                                <form method="post" id="processPayment">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="bill_desc" id="bill_desc"
                                                        value="{{permit.PremiseName}}">
                                                    <input type="hidden" name="currency" id="bill_currency"
                                                        value="{{permit.Currency}}">
                                                    <input type="hidden" name="bill_ref_number" id="bill_ref_number"
                                                        value="{{permit.RetailDealersNo}}">
                                                    <input type="hidden" name="client_name" id="client_name"
                                                        value="{{permit.ApplicantName}}">
                                                    <input type="hidden" name="amount_expected" id="amount_expected"
                                                        value="{{permit.AmountPayable}}">
                                                    <input type="hidden" name="Veterinary_Classes"
                                                        id="Veterinary_Classes" value="RETAIL PREMISE PERMIT">
                                                    <input type="hidden" name="Process" id="Process"
                                                        value="INSPECTORATE">
                                                    <input type="hidden" name="Types_Of_Manufacturers"
                                                        id="Types_Of_Manufacturers" value="Local">
                                                    <button class="btn btn-primary btn-icon icon-left"><i
                                                            class="fas fa-credit-card"></i> Process Payment</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Downloads</h4>
                    </div>
                    <div class="card-body">
                        <div class="money-spinner mx-auto text-center" id="spinner5" style="display: none;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                alt="Loading Gif" style="height: 70px; width: 100px;" class="img-fluid">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped data_table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Application Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Application Form</td>
                                        <td>
                                            {% if permit.Status == "Open" %}
                                            <div class="badge badge-info">{{permit.Status}}</div>
                                            {% elif permit.Status == "Processing" %}
                                            <div class="badge badge-warning">{{permit.Status}}</div>
                                            {% elif permit.Status == "Approved" %}
                                            <div class="badge badge-success">{{permit.Status}}</div>
                                            {% elif permit.Status == "Rejected" %}
                                            <div class="badge badge-danger">{{permit.Status}}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <form
                                                action="{% url 'PrintRetailDealersPermitApplicationForm' permit.RetailDealersNo %}"
                                                method="post">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-info">
                                                    <i class="las la-download"></i> Download
                                                    Application Form
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% if permit.Paid == True %}
                                    <tr id="receipt_card">
                                        <td>Retail Dealer Premise Permit Receipt</td>
                                        <td>
                                            {% if permit.Status == "Open" %}
                                            <div class="badge badge-info">{{permit.Status}}</div>
                                            {% elif permit.Status == "Processing" %}
                                            <div class="badge badge-warning">{{permit.Status}}</div>
                                            {% elif permit.Status == "Approved" %}
                                            <div class="badge badge-success">{{permit.Status}}</div>
                                            {% elif permit.Status == "Rejected" %}
                                            <div class="badge badge-danger">{{permit.Status}}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <form id="FnGenerateReceipt" method="post">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-info">
                                                    <i class="las la-download"></i> Download Receipt
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% if permit.Status == "Approved" %}
                                    <tr id="cert_card">
                                        <td>Retail Dealer Premise Permit Certificate</td>
                                        <td>
                                            {% if permit.Status == "Open" %}
                                            <div class="badge badge-info">{{permit.Status}}</div>
                                            {% elif permit.Status == "Processing" %}
                                            <div class="badge badge-warning">{{permit.Status}}</div>
                                            {% elif permit.Status == "Approved" %}
                                            <div class="badge badge-success">{{permit.Status}}</div>
                                            {% elif permit.Status == "Rejected" %}
                                            <div class="badge badge-danger">{{permit.Status}}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <form id="PremiseCertForm" method="post">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-info">
                                                    <i class="las la-download"></i> Download
                                                    Certificate
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        Retail Veterinary Pharmacy Permit Application {{permit.RetailDealersNo}} Details</h4>
                    </div>
                    <div class="card-body">
                        <form action="{% url 'RetailersPermit' %}" class="bg-white p-4" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="retailDealersNo" value="{{permit.RetailDealersNo}}">
                            <input type="hidden" name="myAction" id="myAction" value="modify">
                            <input type="hidden" name="iAgree" value="True">
                            <div class="tab">
                                <div class="border border-success rounded p-3 my-3">
                                    <p class="text-small text-primary">Applicant's Information
                                    </p>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Applicant Name </label>
                                            <input type="text" class="form-control" name="applicantName"
                                                id="applicantName" value="{{permit.ApplicantName}}" disabled>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Application Date</label>
                                            <input type="text" class="form-control" value="{{permit.ApplicationDate}}"
                                                disabled>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Amount Payable</label>
                                            <input type="text" class="form-control" value="{{permit.AmountPayable}}"
                                                disabled>
                                        </div>
                                    </div>
                                    <div class="row my-3">
                                        <div class="col-md-4">
                                            <label class="form-label">First Time Application <span
                                                    class="text-danger">*</span></label>
                                            <select class="form-control" aria-label="Default select example"
                                                name="firstTimeApplication" id="firstTimeApplication" disabled>
                                                <option selected value="0" disabled>--select--</option>
                                                <option value="1">Yes</option>
                                                <option value="2">No</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Previous Inspection </label>
                                            <select class="form-control" aria-label="Default select example"
                                                name="inspectionNo" id="inspectionNo" disabled>
                                                <option selected value="" disabled>--select--</option>
                                                {% for inspection in Approved_Inspection %}
                                                <option value="{{inspection.PremiseInpectionNo}}">
                                                    {{inspection.CompanyName}}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        {% if permit.First_Time_Application == "No" %}
                                        <div class="col-md-4">
                                            <label class="form-label">Last Paid Date</label>
                                            <input type="text" class="form-control" value="{{permit.Last_Paid_Date}}"
                                                disabled>
                                        </div>
                                        {% else %}
                                        <div class="col-md-4">
                                            <label class="form-label">Invoiced</label>
                                            <input type="text" class="form-control" value="{{permit.Invoiced}}"
                                                disabled>
                                        </div>
                                        {% endif %}
                                    </div>

                                </div>
                            </div>
                            <div class="border border-success rounded p-3 my-3">
                                <p class="text-small text-primary">Supervising Veterinary Information
                                </p>
                                <div class="row my-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="name" id="name"
                                            value="{{permit.Name}}" disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Professional RegNo <span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="professionalRegNo"
                                            id="EditProfessionalRegNo" value="{{permit.Professinal_No}}" disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Email<span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" name="email" id="email"
                                            value="{{permit.E_mail}}" disabled>
                                    </div>

                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Cell Phone <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="cellPhone" id="cellPhone"
                                            value="{{permit.Cell_No}}" disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Alternative Cell Phone (07 XXXXXXX)<span
                                                class="text-danger">*</span></label>
                                        <input type="number" class="form-control" name="alternative_cellPhone"
                                            id="alternative_cellPhone" value="{{permit.Alternative_Cell_Phone}}"
                                            disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Qualification <span
                                                class="text-danger">*</span></label>
                                        <select class="form-control" aria-label="Default select example"
                                            name="qualification" id="qualification" disabled>
                                            {% for qualification in qualifications %}
                                            <option value="{{qualification.ProposedCategory}}"
                                                {% if qualification.ProposedCategory == permit.ProposedCategory %}selected{% endif %}>
                                                {{qualification.ProposedCategory}} : {{qualification.Description}}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="border border-success rounded p-3 my-3">
                                <p class="text-small text-primary">General Details
                                </p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Premise Name</label>
                                        <input type="text" class="form-control" name="premiseName" id="premiseName"
                                            value="{{permit.PremiseName}}" disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Town <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="town" id="town"
                                            value="{{permit.Town}}" disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Road <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="road" id="road"
                                            value="{{permit.Road}}" disabled>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        <label class="form-label">Building <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="building" id="building"
                                            value="{{permit.Building}}" disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Plot No</label>
                                        <input type="text" class="form-control" name="plotNo" id="plotNo"
                                            value="{{permit.Plot_No}}" disabled>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Application Starting Year <span
                                                class="text-danger">*</span></label>
                                        <input type="number" class="form-control" name="application_year"
                                            id="application_year" min="2024" value="{{permit.Application_Year}}">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary my-3 w-100" id="edit_header" hidden>Edit
                                    Form</button>
                            </div>
                        </form>
                    </div>
                    {% include 'alert.html' %}
                </div>
            </div>
        </div>
        <div class="row mt-3" id="submitted_pros" style="display: none;">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Other Professionals Working in the Pharmacy</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped data_table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Pro Reg No.</th>
                                        <th>Nationality</th>
                                        <th>ID/Passport/Alien ID No.</th>
                                        <th>Position</th>
                                        <th>Qualification</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for line in lines %}
                                    <tr>
                                        <td>{{line.Name}}</td>
                                        <td>{{line.Professional_Reg__No}}</td>
                                        <td>{{line.Nationality_Description}}</td>
                                        <td>{{line.IDOrPassportOrAlien_ID_No}}</td>
                                        <td>{{line.PositionIntheBusiness}}</td>
                                        <td>{{line.Qualification}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3" id="submitted_docs" style="display: none;">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Uploaded Files</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped data_table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>File Name</th>
                                        <th>File Type</th>
                                        <th>Date Attached</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attachment in attachments %}
                                    <tr>
                                        <td>{{attachment.AuxiliaryIndex2}}</td>
                                        <td>{{attachment.File_Name}}</td>
                                        <td>{{attachment.File_Type}}</td>
                                        <td id="Sub_Attached_Date{{attachment.AuxiliaryIndex2}}">
                                            {{attachment.Attached_Date}}</td>
                                        <script>
                                            $(document).ready(function () {
                                                $("#Sub_Attached_Date{{attachment.AuxiliaryIndex2}}")
                                                    .empty().append(moment(
                                                            '{{attachment.Attached_Date}}', "YYYY-MM-DD")
                                                        .format(
                                                            'Do MMM YYYY'));
                                            })
                                        </script>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>
<script>
    $(document).ready(function () {

        var Nationality = '{{permit.Nationality}}';
        var documentStatus = '{{permit.Status}}';
        var AmountPayable = '{{permit.AmountPayable}}';
        var document_header = '{{permit.RetailDealersNo}}';
        var Invoiced = false;
        var Paid = false;
        var firstTimeApplication = '{{permit.First_Time_Application}}';
        var Qualification = '{{permit.Qualification}}';
        var Document_Stage = '{{permit.Document_Stage}}';

        const $stepTwo = $('#stepTwo');
        const $Professionals_btn = $('#Professionals_btn');
        const $ProfessionalsNext = $('#ProfessionalsNext');
        const $ProfessionalsForm = $('#ProfessionalsForm');
        const $addRetailLine = $('#addRetailLine')
        const $ProfessionalsTable = $('#ProfessionalsTable')
        const $hideRetailLine = $('#hideRetailLine')

        const $stepThree = $('#stepThree');
        const $FNGenerateInvoice = $('#FNGenerateInvoice');
        const $attachmentForm = $('#attachmentForm');
        const $AttachmentsPrev = $('#AttachmentsPrev');
        const $AttachmentsNext = $('#AttachmentsNext');
        const $stepFour = $('#stepFour');
        const $paymentPrev = $('#paymentPrev');
        const $payment_submit_form = $('#payment_submit_form');
        const $payment_state = $('#payment_state');
        const $PremiseCertForm = $('#PremiseCertForm');
        const $payment_box = $('#payment_box');
        const $summary_box = $('#summary_box');
        const $ApplicationRow = $('#ApplicationRow');
        const $edit_header = $('#edit_header');
        const $submitted_pros = $('#submitted_pros');
        const $submitted_docs = $('#submitted_docs');
        const $pesa_paid = $('.pesa_paid');
        const $cert_card = $('#cert_card');
        const $confirm_div = $('.confirm_div');
        const $processPayment = $('#processPayment');
        const $FnGenerateReceipt = $('#FnGenerateReceipt');


        $addRetailLine.click(() => {
            const $tablewrapper = $('#ProfessionalsTable_wrapper')
            $ProfessionalsForm.show(1000)
            $ProfessionalsTable.hide()
            $addRetailLine.hide()
            $tablewrapper.hide()
        })

        $hideRetailLine.click(() => {
            const $tablewrapper = $('#ProfessionalsTable_wrapper')
            $ProfessionalsForm.hide()
            $ProfessionalsTable.show(1000)
            $addRetailLine.show()
            $tablewrapper.fadeIn(2000)
        })

        filter_list(document_header);
        loadProfessionals(document_header);
        TechnicalRequirementsData(
            document_header);
        Load_Attachments(document_header);

        if (firstTimeApplication == 'YES') {
            $('#firstTimeApplication option[value="1"]').prop('selected', true);
            $('#inspectionNo option[value=""]').prop('selected', true).prop('disabled', true);
        } else if (firstTimeApplication == 'NO') {
            $('#firstTimeApplication option[value="2"]').prop('selected', true);
            $('#inspectionNo option[value="' + inspectionNo + '"]').prop('selected', true);
        } else {
            $('#firstTimeApplication option[value="0"]').prop('selected', true);
            $('#inspectionNo option[value=""]').prop('selected', true).prop('disabled', true);
        }

        if (Qualification == 'Veterinary Surgeon') {
            $('#qualification option[value="0"]').prop('selected', true);
        } else if (Qualification == 'Veterinary Technologist Degree') {
            $('#qualification option[value="1"]').prop('selected', true);
        } else if (Qualification == 'Veterinary Technologist Diploma') {
            $('#qualification option[value="2"]').prop('selected', true);
        } else {
            $('#qualification option[value="3"]').prop('selected', true);
        }

        if (Document_Stage === 'Not Submitted') {
            $('#premiseName').prop('disabled', false);
            $('#town').prop('disabled', false);
            $('#road').prop('disabled', false);
            $('#building').prop('disabled', false);
            $('#firstTimeApplication').prop('disabled', false);
            $('#plotNo').prop('disabled', false);
            $('#applicantName').prop('disabled', false);
            $('#inspectionNo').prop('disabled', false);
            $('#email').prop('disabled', false);
            $('#cellPhone').prop('disabled', false);
            $('#alternative_cellPhone').prop('disabled', false);
            $('#application_year').prop('disabled', false);
            $('#name').prop('disabled', false);
            $('#EditProfessionalRegNo').prop('disabled', false);
            $('#qualification').prop('disabled', false);
        }
        $AttachmentsNext.click(function () {
            $stepFour.show();
            $stepThree.hide();
            $("#other_professionals").empty().append("Payment Details")
        })

        $AttachmentsPrev.click(function () {
            filter_list(document_header);
            $stepTwo.show();
            $stepThree.hide();
        })


        $paymentPrev.click(function () {
            $stepFour.hide();
            $stepThree.show();
        })

        $ProfessionalsForm.on('submit', (e) => {
            e.preventDefault();
            if ($('#pro_name').val() === '' || $('#position_in_business')
                .val() === '' || $('#Experience').val() === '' || $('#Qualification').val() === '' || $(
                    '#nationality')
                .val() === '' || $('#iDorPassportOrAlienIDNo')
                .val() === '') {
                alert('Please fill in all required fields.');
                return false;
            }
            $("#spinner1").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/retailer/' + document_header + "/",
                data: {
                    myAction: $("#Professionals_my_action").val(),
                    lineNo: $('#Professionals_lineNo').val(),
                    pro_name: $('#pro_name').val(),
                    position_in_business: $('#position_in_business').val(),
                    nationality: $('#nationality').val(),
                    iDorPassportOrAlienIDNo: $('#iDorPassportOrAlienIDNo').val(),
                    professionalRegNo: $('#professionalRegNo').val(),
                    Qualification: $('#Qualification').val(),
                    Experience: $('#Experience').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response['response']) {
                        loadProfessionals(document_header);
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Created successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                        $('#pro_name, #position_in_business, #professionalRegNo, #nationality, #iDorPassportOrAlienIDNo')
                            .val(
                                '');
                        $('#Qualification, #Experience').val('');
                    } else if (response['error']) {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response['error'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner1").hide();
                },
                error: function (error) {
                    console.log(error)
                    $("#spinner1").hide();
                }
            });
        });

        $ProfessionalsNext.click(function () {
            if (Invoiced === false && Paid === false) {
                $("#spinner2").show();
                $.ajax({
                    type: 'POST',
                    url: '/selfservice/RetailCustomer/',
                    data: {
                        RetailDealersNo: document_header,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function (response) {
                        if (response['response']) {
                            iziToast.show({
                                theme: 'dark',
                                backgroundColor: '#0974bd',
                                icon: 'las la-check-circle',
                                title: "Pay" + " " + AmountPayable,
                                position: 'topRight',
                                progressBarColor: '#F4F6F7',
                            });
                            $("#spinner2").hide();
                            $stepTwo.hide();
                            $stepThree.show();
                            $('#other_professionals').empty().append('Upload Attachments')
                        } else if (response['error']) {
                            iziToast.show({
                                theme: 'dark',
                                icon: 'las la-exclamation',
                                title: 'Error',
                                message: response['error'],
                                position: 'topRight',
                                progressBarColor: '#ff0800',
                            });
                        }
                        $("#spinner2").hide();
                    },
                    error: function (error) {
                        console.log(error)
                        $("#spinner2").hide();
                    }
                });
            } else {
                $stepTwo.hide();
                $stepThree.show();
            }
        })


        $attachmentForm.on("submit", (e) => {
            e.preventDefault();
            $("#spinner3").show();
            var formData = new FormData($attachmentForm[0]);

            let attachments = $('#attachments')[0];
            var attachmentCode = $('#attachmentCode').val();

            for (let i = 0; i < attachments.files.length; i++) {
                formData.append('attachment', attachments.files[i]);
            }

            formData.append('attachmentCode', attachmentCode);

            $.ajax({
                url: "/selfservice/RetailPermitAttachments/" + document_header + "/",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function (data) {

                    $('#attachments').val('');
                    if (data['success'] == true) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Uploaded successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                        Load_Attachments(document_header);
                        TechnicalRequirementsData(document_header);
                    } else {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: "Upload failed: " + data,
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner3").hide();
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log(xhr.responseText);
                    $("#spinner3").hide();
                }
            });
        });

        $processPayment.on('submit', (e) => {
            e.preventDefault();
            $("#spinner6").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/PesaflowPaymentView/',
                data: {
                    bill_desc: $('#bill_desc').val(),
                    currency: $('#bill_currency').val(),
                    bill_ref_number: $('#bill_ref_number').val(),
                    client_name: $('#client_name').val(),
                    amount_expected: $('#amount_expected').val(),
                    Veterinary_Classes: $('#Veterinary_Classes').val(),
                    Types_Of_Manufacturers: $('#Types_Of_Manufacturers').val(),
                    Process: $('#Process').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    const invoiceLink = response.response_data.invoice_link;

                    window.open(invoiceLink);

                    $("#spinner6").hide();
                },
                error: function (error) {
                    console.log(error);
                    $("#spinner6").hide();
                }
            });
        });

        $payment_submit_form.on('submit', (e) => {
            e.preventDefault();
            $("#spinner4").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/submit/retail/' + document_header + "/",
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response['response']) {
                        filter_list(document_header);
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Submitted successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                        window.location.href = "/selfservice/dashboard";
                    } else if (response['error']) {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response['error'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner4").hide();
                },
                error: function (error) {
                    console.log(error)
                    $("#spinner4").hide();
                }
            });
        });

        $PremiseCertForm.on('submit', (e) => {
            e.preventDefault();
            $("#spinner5").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/retail/cert/' + document_header + '/',
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                xhrFields: {
                    responseType: 'blob'
                },
                success: function (response) {
                    const blob_cert = new Blob([response], {
                        type: 'application/pdf'
                    });
                    const urls = window.URL.createObjectURL(blob_cert);

                    // Open the PDF in a new tab
                    const newTab = window.open();
                    newTab.document.open();
                    newTab.document.write('<iframe src="' + urls +
                        '" width="100%" height="100%"></iframe>');
                    newTab.document.close();

                    window.URL.revokeObjectURL(urls);
                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#0974bd',
                        icon: 'las la-check-circle',
                        title: 'Downloaded successfully',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                    $("#spinner5").hide();
                },
                error: function (error) {
                    console.log(error);
                    $("#spinner5").hide();
                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#E74C3C',
                        icon: 'las la-times-circle',
                        title: 'Error',
                        message: 'An error occurred',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                }
            });
        });

        $FnGenerateReceipt.on('submit', (e) => {
            e.preventDefault();
            $("#spinner5").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/FnGenerateReceipt/' + document_header + '/',
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                xhrFields: {
                    responseType: 'blob'
                },
                success: function (response) {
                    const blob_cert = new Blob([response], {
                        type: 'application/pdf'
                    });
                    const urls = window.URL.createObjectURL(blob_cert);

                    // Open the PDF in a new tab
                    const newTab = window.open();
                    newTab.document.open();
                    newTab.document.write('<iframe src="' + urls +
                        '" width="100%" height="100%"></iframe>');
                    newTab.document.close();

                    window.URL.revokeObjectURL(urls);

                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#0974bd',
                        icon: 'las la-check-circle',
                        title: 'Downloaded successfully',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                    $("#spinner5").hide();
                },
                error: function (error) {
                    console.log(error);
                    $("#spinner5").hide();
                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#E74C3C',
                        icon: 'las la-times-circle',
                        title: 'Error',
                        message: 'An error occurred',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                }
            });
        });

        function filter_list(pk) {
            var query = '/QyRetailDealersPremisePermit'
            var filter_one = 'RetailDealersNo'
            var filter_two = 'UserCode'


            $.ajax({
                url: "/selfservice/filter_list/" + pk,
                type: "GET",
                dataType: "json",
                data: {
                    query: query,
                    filter_one: filter_one,
                    filter_two: filter_two,
                },
                success: function (data) {
                    if (data['success'] == true) {
                        $('.document_status').empty().append(data['data']['Status']);
                        $('.Currency').empty().append(data['data']['Currency']);
                        $('.AmountPayable').empty().append(data['data']['AmountPayable']);

                        Invoiced = data['data']['Invoiced']
                        Paid = data['data']['Paid']

                        if (data['data']['Paid'] === true) {
                            $payment_submit_form.css('display', 'inline-block');
                            $payment_state.empty().append("Paid");
                            $pesa_paid.addClass('text-success');
                        }

                        if (data['data']['Document_Stage'] === 'Not Submitted') {
                            $payment_box.show();
                            $summary_box.hide();
                            $stepTwo.show();
                            $edit_header.prop('disabled', false);
                            $edit_header.removeAttr("hidden")

                            if (data['data']['Paid'] === true) {
                                $payment_box.hide();
                                $summary_box.show();
                                $processPayment.hide();
                            }

                        } else if (data['data']['Document_Stage'] === 'Submitted') {
                            $edit_header.prop('disabled', true);
                            $edit_header.hide()
                            $ApplicationRow.hide();
                            $submitted_pros.show();
                            $submitted_docs.show();
                            $payment_submit_form.css('display', 'none');
                            $ProfessionalsForm.hide();
                            $attachmentForm.hide();
                            $confirm_div.hide();
                            $stepTwo.hide();
                            $stepThree.hide();
                            $stepFour.hide();
                            $payment_box.hide();
                            $summary_box.hide();
                            if (data['data']['Status'] === 'Approved') {
                                $cert_card.show();
                            }

                        }

                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });

        }

        function handleFormSubmission(form) {
            event.preventDefault();
            $("#spinner2").show();
            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'),
                data: form.serialize(),
                success: function (response) {
                    loadProfessionals(document_header);
                    if (response['response']) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            message: "deleted",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                    } else {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response[
                                'message'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner2").hide();
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                    iziToast.show({
                        theme: 'dark',
                        icon: 'las la-exclamation',
                        title: 'Error',
                        message: 'CSRF verification failed. Request aborted.',
                        position: 'topRight',
                        progressBarColor: '#ff0800',
                    });
                    $("#spinner2").hide();
                }
            });
        }


        function loadProfessionals(pk) {
            $.ajax({
                url: "/selfservice/RetailProfessionals/" + pk + "/",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var tableBody = $('#ProfessionalsTable tbody');
                    tableBody.empty(); // clear existing rows if any
                    // iterate through the data and append to the table
                    for (var i = 0; i < data[1].length; i++) {
                        var Name = data[1][i].Name;
                        var Nationality = data[1][i].Nationality_Description;
                        var IDOrPassportOrAlienIDNo = data[1][i].IDOrPassportOrAlien_ID_No;
                        var PositionIntheBusiness = data[1][i].PositionIntheBusiness;
                        var ProfessionalRegNo = data[1][i].Professional_Reg__No;
                        var QualificationAndExperience = data[1][i].Qualification;
                        let Line_No = data[1][i].RetailDealersLineNo;
                        var PremiseNo = data[1][i].RetailDealersNo;
                        var RegistrationNo = data[1][i].RegistrationNo;

                        var modalHtml =
                            '<div class="modal fade" tabindex="-1" role="dialog" id="edit_permit_modal' +
                            Line_No + '">' +
                            '<div class="modal-dialog modal-lg" role="document">' +
                            '<div class="modal-content">' +
                            '<div class="modal-header">' +
                            '<h5 class="modal-title">Edit Line - ' + Line_No + '</h5>' +
                            '<button type="button" class="close" data-dismiss="modal" aria-label="Close">' +
                            '<span aria-hidden="true">&times;</span>' +
                            '</button>' +
                            '</div>' +
                            '<div class="modal-body">' +
                            '<div class="money-spinner mx-auto text-center" id="line_spinner' +
                            Line_No + '" style="display: none;">' +
                            '<img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif" alt="Loading Gif" style="height: 70px; width: 70px;" class="img-fluid">' +
                            '</div>' +
                            '<form id="editLineForm' + Line_No + '">' +
                            '{% csrf_token %}' +
                            '<input type="hidden" name="PremiseNo" id="PremiseNo' + Line_No +
                            '" value="' + PremiseNo + '">' +
                            '<input type="hidden" name="lineNo" id="lineNo' + Line_No +
                            '" value="' + Line_No + '">' +
                            '<div class="row gx-2">' +
                            '<div class="col-md-6">' +
                            '<label class="form-label">Full Name <span class="text-danger">*</span></label>' +
                            '<input type="text" class="form-control" name="pro_name" id="pro_name' +
                            Line_No + '" value=' + Name + ' required>' +
                            '</div>' +
                            '<div class="col-md-6">' +
                            '<label class="form-label">Professional Reg No.</label>' +
                            '<input type="text" class="form-control" name="professionalRegNo" id="professionalRegNo' +
                            Line_No + '" value=' + ProfessionalRegNo + '>' +
                            '</div>' +
                            '</div>' +
                            '<div class="row gx-2">' +
                            '<div class="col-md-12">' +
                            // Change column size to col-md-6 for better spacing
                            '<label class="form-label">ID/Passport/Alien ID No <span class="text-danger">*</span></label>' +
                            '<input type="text" class="form-control" name="iDorPassportOrAlienIDNo" id="iDorPassportOrAlienIDNo' +
                            Line_No + '" value=' + IDOrPassportOrAlienIDNo + '>' +
                            '</div>' +
                            '</div>' +
                            '<div class="row my-3 gx-2">' +
                            '<div class="col-md-6">' +
                            // Change column size to col-md-6 for better spacing
                            '<label class="form-label">Nationality <span class="text-danger">*</span></label>' +
                            '<select class="form-control" aria-label="Default select example" name="nationality" id="nationality' +
                            Line_No + '">' +
                            '</select>' +
                            '</div>' +
                            '<div class="col-md-6">' +
                            // Change column size to col-md-6 for better spacing
                            '<label class="form-label">Position in the Business <span class="text-danger">*</span></label>' +
                            '<input type="text" class="form-control" name="position_in_business" id="position_in_business' +
                            Line_No + '" value=' + PositionIntheBusiness + ' required>' +
                            '</div>' +
                            '</div>' +
                            '<div class="row my-3">' +
                            '<div class="col-md-6">' +
                            // Change column size to col-md-6 for better spacing
                            '<label class="form-label">Qualification <span class="text-danger">*</span></label>' +
                            '<input type="text" class="form-control" name="Qualification" id="Qualification' +
                            Line_No + '" value=' + QualificationAndExperience + ' required>' +
                            '</div>' +
                            '<div class="col-md-6">' +
                            // Change column size to col-md-6 for better spacing
                            '<label class="form-label">Experience<span class="text-danger">*</span></label>' +
                            '<input type="text" class="form-control" name="Experience" id="Experience' +
                            Line_No + '" required>' +
                            '</div>' +
                            '</div>' +
                            '<button type="submit" class="btn btn-primary mr-1 my-2 w-100">Edit Line</button>' +
                            '</form>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '</div>';

                        var row = $('<tr>');
                        row.append($('<td>').text(Name));
                        row.append($('<td>').text(ProfessionalRegNo));
                        row.append($('<td>').text(Nationality));
                        row.append($('<td>').text(IDOrPassportOrAlienIDNo));
                        row.append($('<td>').text(PositionIntheBusiness));
                        row.append($('<td>').text(QualificationAndExperience));

                        if (Document_Stage === 'Not Submitted') {
                            var form = $('<form>').attr({
                                method: 'POST',
                                action: '/selfservice/retailer/' + pk + '/',
                            }).append('{% csrf_token %}');

                            var pro_Name = $('<input>').attr({
                                type: 'hidden',
                                name: 'pro_name',
                                value: "0"
                            });
                            var pro_position_in_business = $('<input>').attr({
                                type: 'hidden',
                                name: 'position_in_business',
                                value: "0"
                            });
                            var pro_nationality = $('<input>').attr({
                                type: 'hidden',
                                name: 'nationality',
                                value: "KE"
                            });
                            var pro_iDorPassportOrAlienIDNo = $('<input>').attr({
                                type: 'hidden',
                                name: 'iDorPassportOrAlienIDNo',
                                value: "0"
                            });
                            var pro_professionalRegNo = $('<input>').attr({
                                type: 'hidden',
                                name: 'professionalRegNo',
                                value: "0"
                            });
                            var pro_Qualification = $('<input>').attr({
                                type: 'hidden',
                                name: 'Qualification',
                                value: "0"
                            });
                            var pro_Experience = $('<input>').attr({
                                type: 'hidden',
                                name: 'Experience',
                                value: "0"
                            });
                            var pro_lineNoInput = $('<input>').attr({
                                type: 'hidden',
                                name: 'lineNo',
                                value: Line_No
                            });
                            var pro_myActionInput = $('<input>').attr({
                                type: 'hidden',
                                name: 'myAction',
                                value: 'delete'
                            });
                            var deleteBtn = $('<button>').attr({
                                type: 'submit',
                                class: 'btn btn-danger ml-1'
                            }).html('<i class="fas fa-trash-alt"></i>');

                            var editBtn = $('<a>').attr({
                                class: "btn btn-primary text-white",
                                type: "button",
                                "data-toggle": "modal",
                                "data-target": "#edit_permit_modal" + Line_No,
                                id: "editBtn" + Line_No,
                            }).html('<i class="fas fa-pencil-alt"></i>');

                            var buttonGroup = $('<div class="btn-group mr-2">');
                            buttonGroup.append(editBtn, deleteBtn);

                            // Handle form submission
                            form.submit(function (event) {
                                handleFormSubmission($(this));
                            });

                            var td = $('<td>').append(form.append(pro_Name,
                                pro_position_in_business,
                                pro_nationality,
                                pro_iDorPassportOrAlienIDNo,
                                pro_professionalRegNo,
                                pro_Qualification, pro_Experience, pro_lineNoInput,
                                pro_myActionInput, buttonGroup));
                            row.append(td);
                        }
                        tableBody.append(row);
                        $('body').append(modalHtml);
                    }

                    var submit_line = $('#submit_line');

                    $('body').on('click',
                        '[data-toggle="modal"][data-target^="#edit_permit_modal"]',
                        function () {
                            var modalId = $(this).attr('data-target');
                            var Line_No = modalId.replace('#edit_permit_modal', '');

                            $.ajax({
                                url: '/selfservice/GetCountries/',
                                type: 'GET',
                                dataType: 'json',
                                success: function (items) {
                                    var modal = $(modalId);

                                    var optionsHtml = '';
                                    for (var j = 0; j < items.length; j++) {
                                        optionsHtml +=
                                            `<option value="${items[j].Code}">${items[j].Name}</option>`;
                                    }
                                    modal.find('select[name="nationality"]').html(
                                        optionsHtml);
                                },
                                error: function (xhr, status, error) {
                                    console.log('Error:', error);
                                }
                            });
                        });



                    if (tableBody.children().length > 0) {
                        submit_line.html('<i class="las la-plus"></i> Add More Lines');

                    } else if (tableBody.children().length <= 0) {
                        submit_line.text('Save');
                    }


                    if (tableBody.children().length > 0) {
                        submit_line.html('<i class="las la-plus"></i> Add More Lines');

                    } else if (tableBody.children().length <= 0) {
                        submit_line.text('Save');
                    }


                    // initialize DataTables for each table
                    if (!$.fn.DataTable.isDataTable('#ProfessionalsTable')) {
                        $('#ProfessionalsTable').DataTable({
                            "pageLength": 5,
                            "order": [
                                [0, "desc"]
                            ]
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }

        function showSpinner(lineNo) {
            $('#line_spinner' + lineNo).show();
        }

        function hideSpinner(lineNo) {
            $('#line_spinner' + lineNo).hide();
        }

        function hideModal(lineNo) {
            $('#edit_permit_modal' + lineNo).modal('hide');
        }

        $(document).on("submit", "form[id^='editLineForm']", function (e) {
            e.preventDefault();

            // Get the CSRF token
            var csrf_token = $(this).find("[name='csrfmiddlewaretoken']").val();

            // Get the parameter values
            var myAction = "modify";
            var lineNo = $(this).find("[name='lineNo']").val();
            var pro_name = $(this).find("[name='pro_name']").val();
            var position_in_business = $(this).find("[name='position_in_business']").val();
            var Experience = $(this).find("[name='Experience']").val();
            var professionalRegNo = $(this).find("[name='professionalRegNo']").val();
            var Qualification = $(this).find("[name='Qualification']").val();
            var nationality = $(this).find("[name='nationality']").val();
            var iDorPassportOrAlienIDNo = $(this).find("[name='iDorPassportOrAlienIDNo']").val();
            var PremiseNo = $(this).find("[name='PremiseNo']").val();

            showSpinner(lineNo);

            $.ajax({
                url: '/selfservice/retailer/' + PremiseNo + "/",
                type: "POST",
                dataType: "json",
                data: {
                    myAction: myAction,
                    lineNo: lineNo,
                    pro_name: pro_name,
                    position_in_business: position_in_business,
                    Experience: Experience,
                    professionalRegNo: professionalRegNo,
                    Qualification: Qualification,
                    nationality: nationality,
                    iDorPassportOrAlienIDNo: iDorPassportOrAlienIDNo,
                    csrfmiddlewaretoken: csrf_token
                },
                success: function (response) {
                    hideSpinner(lineNo);
                    hideModal(lineNo);
                    loadProfessionals(PremiseNo);
                    if (response['response']) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Edited successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                    } else if (response['error']) {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response['error'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.log(data);
                    hideSpinner(lineNo);
                    hideModal(lineNo);
                },
            });
        });

        function TechnicalRequirementsData(pk) {
            $("#attachmentForm select[name='attachmentCode']").find('.after').nextAll().remove();
            $.ajax({
                url: "/selfservice/TechnicalRequirements/" + pk + "/",
                type: "GET",
                dataType: "json",
                data: {
                    filter: "RETAILER PERMIT",
                    firstTimeApplication: firstTimeApplication,
                },
                success: function (data) {
                    if (data.length > 0) {
                        $("#AttachmentsNext").hide();
                        let options = '';
                        for (var i = 0; i < data.length; i++) {
                            const formattedDescription = data[i].Description.replace(/ /g, '_');
                            options += '<option value="' + formattedDescription + '">' + data[i]
                                .Description + '</option>';
                        }
                        $("#attachmentForm select[name='attachmentCode']").find('.after').after(
                            options);
                    } else {
                        $("#AttachmentsNext").show();
                        preview_invoice(document_header);
                        const emptyOption =
                            '<option disabled selected>You have nothing to attach</option>';
                        $("#attachmentForm select[name='attachmentCode']").find('.after').after(
                            emptyOption);
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }

        function preview_invoice(pk) {
            $.ajax({
                type: 'POST',
                url: '/selfservice/RetailerInvoice/',
                data: {
                    premiseNo: pk,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                xhrFields: {
                    responseType: 'blob' // Set the response type to 'blob'
                },
                success: function (response) {
                    const blob = new Blob([response], {
                        type: 'application/pdf'
                    });
                    const url = window.URL.createObjectURL(blob);

                    // Display the PDF in the iframe
                    const pdfContainer = document.getElementById('pdfContainer');
                    pdfContainer.innerHTML = '<iframe src="' + url +
                        '" width="100%" height="600"></iframe>';

                    window.URL.revokeObjectURL(url);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        function Load_Attachments(pk) {
            $.ajax({
                url: "/selfservice/RetailPermitAttachments/" + document_header + "/",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var containerDiv = $("#attachments-container");
                    containerDiv.empty(); // clear the container div
                    for (var i = 0; i < data.length; i++) {
                        (function () {
                            var docID = data[i].AuxiliaryIndex2;
                            var tableID = data[i].Table_ID;
                            var attachmentID = data[i].AuxiliaryIndex2;
                            var File_Name = data[i].File_Name;
                            var File_Extension = data[i].File_Extension;

                            // create a new div for this attachment
                            var attachmentDiv = $("<div>", {
                                class: "col-md-3"
                            });
                            var fileManBoxDiv = $("<div>", {
                                class: "file-man-box"
                            });
                            // create the form for deleting the attachment
                            if (Document_Stage === 'Not Submitted') {
                                var deleteForm = $("<form>", {
                                    method: "POST"
                                });
                                deleteForm.append($("<input>", {
                                    type: "hidden",
                                    name: "docID",
                                    value: docID
                                }));
                                deleteForm.append($("<input>", {
                                    type: "hidden",
                                    name: "tableID",
                                    value: tableID
                                }));
                                var deleteButton = $("<button>", {
                                    class: "file-close",
                                    id: "file-close",
                                    style: "background-color: white !important;"
                                }).append($("<i>", {
                                    class: "las la-times-circle",
                                }));
                                deleteButton.on("click", function (event) {
                                    event.preventDefault();
                                    $("#spinner3").show();
                                    $.ajax({
                                        type: 'POST',
                                        url: "/selfservice/RemoveRetailAttachment/",
                                        data: {
                                            docID: docID,
                                            tableID: tableID,
                                            leaveCode: pk,
                                            csrfmiddlewaretoken: $(
                                                    'input[name=csrfmiddlewaretoken]'
                                                )
                                                .val()
                                        },
                                        success: function (data) {
                                            if (data['success'] == true) {
                                                TechnicalRequirementsData(
                                                    document_header);
                                                iziToast.show({
                                                    theme: 'dark',
                                                    backgroundColor: '#0974bd',
                                                    icon: 'las la-check-circle',
                                                    title: data[
                                                        'message'
                                                    ],
                                                    position: 'topRight',
                                                    progressBarColor: '#F4F6F7',
                                                });
                                                Load_Attachments(pk);

                                            } else {
                                                iziToast.show({
                                                    theme: 'dark',
                                                    icon: 'las la-exclamation',
                                                    title: 'Error',
                                                    message: data[
                                                        'error'
                                                    ],
                                                    position: 'topRight',
                                                    progressBarColor: '#ff0800',
                                                });
                                            }
                                            $("#spinner3").hide();
                                        },
                                        error: function (error) {
                                            console.log(error)
                                            $("#spinner3").hide();
                                        }
                                    });
                                });
                                fileManBoxDiv.append(deleteButton);
                            }
                            // create the div for the file icon
                            var fileImgBoxDiv = $("<div>", {
                                class: "file-img-box"
                            }).append($("<img>", {
                                src: "../../static/img/file-download.png",
                                alt: "icon"
                            }));
                            fileManBoxDiv.append(fileImgBoxDiv);
                            // create the div for the file name
                            var fileManTitleDiv = $("<div>", {
                                class: "file-man-title"
                            }).append($("<h5>", {
                                class: "mb-0"
                            }).text(File_Name + "." + File_Extension));
                            fileManBoxDiv.append(fileManTitleDiv);
                            attachmentDiv.append(fileManBoxDiv);
                            containerDiv.append(attachmentDiv);
                        })();
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }
    })
</script>
{% endblock %}