{% extends 'base.html' %}
{% load static %}
{% block base %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="{% static 'plugins/Moment/moment.js' %}"></script>
<link rel="stylesheet"
    href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">

<section class="section">
    <div class="section-header">
        <h1>Disposal Request</h1>
        <div class="section-header-breadcrumb">
            <div class="breadcrumb-item active"><a href="{% url 'dashboard' %}">Dashboard</a></div>
            <div class="breadcrumb-item"><a href="{% url 'DisposalApplications' %}">My Applications</a></div>
            <div class="breadcrumb-item">Reference No. {{permit.DisposalNo}}</div>
        </div>
    </div>
    <div class="section-body">
        <div class="row" id="ApplicationRow">
            <div class="col-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4 id="other_professionals">Disposal License Lines</h4>
                    </div>
                    <div class="money-spinner mx-auto text-center" id="spinnerPre" style="display: block;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                            alt="Loading Gif" style="height: 70px; width: 100px;" class="img-fluid">
                    </div>
                    <div class="card-body" style="display: none;" id="disposalSteps">
                        <div class="row">
                            <div class="col-md-12">
                                <div id="stepTwo" class="bg-white p-4" style="display: none">
                                    <div class="border border-success rounded p-3 my-3">
                                        <div class="premise_data" id="premise_data">
                                            <div class="money-spinner mx-auto text-center" id="spinner2"
                                                style="display: none;">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                    alt="Loading Gif" style="height: 70px; width: 100px;"
                                                    class="img-fluid">
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center my-3">
                                                <button class="btn btn-primary" id="addDisposalLine"><i
                                                        class="las la-plus"></i>
                                                    Add
                                                    Line</button>
                                            </div>
                                            <div class="table-responsive">
                                                <table id="ProfessionalsTable"
                                                    class="table w-100 table-striped dt-responsive table-responsive-lg table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th>Product</th>
                                                            <th>Batch No</th>
                                                            <th>Quantity </th>
                                                            <th>Reason For Destruction</th>
                                                            <th>Waste Description</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <form method="POST" id="ProfessionalsForm" style="display: none;">
                                                {% csrf_token %}
                                                <input type="hidden" name="myAction" id="Professionals_my_action"
                                                    value="insert">
                                                <input type="hidden" name="lineNo" id="Professionals_lineNo" value="">
                                                <div class="row">
                                                    <div class="col-md-7">
                                                        <label class="form-label">Type of disposal product<span
                                                                class="text-danger">*</span></label>
                                                        <select class="form-control" aria-label="Default select example"
                                                            name="product_disposal_status" id="product_disposal_status">
                                                            <option selected disabled value="0">--Select--</option>
                                                            <option value="True">Registered product</option>
                                                            <option value="False">Manufacturing waste</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="form-label">Quantity to Dispose/Destroy<span
                                                                class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" name="quantity"
                                                            id="quantity">
                                                    </div>
                                                </div>
                                                <div class="row my-3" id="product_row" style="display: none;">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Product</label>
                                                        <select class="form-control" aria-label="Default select example"
                                                            name="product" id="product" disabled>
                                                            <option selected disabled value="0">--Select product to
                                                                dispose--</option>
                                                            {% for product in product %}
                                                            <option value="{{product.ProductNo}}">
                                                                {{product.Productname}}
                                                            </option>
                                                            {% empty %}
                                                            <option selected disabled value="0">--You have not
                                                                registered any product--
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Batch No.</label>
                                                        <input type="text" class="form-control" name="batchNo"
                                                            id="batchNo" disabled>
                                                    </div>
                                                </div>
                                                <div class="row my-3" id="waste_row" style="display: none;">
                                                    <div class="col-md-12">
                                                        <label class="form-label">Waste Description</label>
                                                        <textarea class="form-control" name="Waste_Description"
                                                            id="Waste_Description" disabled></textarea>
                                                    </div>
                                                </div>
                                                <div class="row my-3">
                                                    <div class="col-md-12">
                                                        <label class="form-label">Reason For Destruction Or Disposition
                                                            <span class="text-danger">*</span></label>
                                                        <select class="form-control" aria-label="Default select example"
                                                            name="reasonForDestruction" id="reasonForDestruction">
                                                            <option selected disabled value="0">Choose...</option>
                                                            <option value="1">Expired</option>
                                                            <option value="2">Improperly Labelled</option>
                                                            <option value="3">Improperly Sealed</option>
                                                            <option value="4">Counterfeit Or Substandard And Adulterated
                                                            </option>
                                                            <option value="5">Damaged</option>
                                                            <option value="6">Prohibited</option>
                                                            <option value="8">Out Of Specification</option>
                                                            <option value="7">Other</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row my-3" id="Other_Reason_Row" style="display: none;">
                                                    <div class="col-md-12">
                                                        <label class="form-label">Other Reason </label>
                                                        <input type="text" class="form-control" name="Other_Reason"
                                                            id="Other_Reason">
                                                    </div>
                                                </div>
                                                <div class="money-spinner mx-auto text-center" id="spinner1"
                                                    style="display: none;">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                        alt="Loading Gif" style="height: 100px; width: 100px;"
                                                        class="img-fluid">
                                                </div>
                                                <div class="d-flex gap-3">
                                                    <button type="submit" id='submit_line'
                                                        class="btn btn-primary mr-1 my-2 w-100">Save
                                                        Line</button>
                                                    <button type="button" class="btn btn-info my-2 ml-1 w-50"
                                                        id="hideDisposalLine"> <i class="las la-eye"></i> View
                                                        Lines</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="w-100">
                                        <div id="Professionals_btn" style="width: fit-content; margin: auto;">
                                            <button class="btn btn-warning" id="ProfessionalsNext">Next Step <i
                                                    class="las la-angle-double-right"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="stepThree" id="stepThree" style="display: none">
                                    <div class="border border-success rounded p-3 my-3">
                                        <div class="m-0 bg-white p-4">
                                            <div class="Attachment_data w-100" id="Attachment_data">
                                                <div class="money-spinner mx-auto text-center" id="spinner3"
                                                    style="display: none;">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                        alt="Loading Gif" style="height: 70px; width: 100px;"
                                                        class="img-fluid">
                                                </div>
                                                <h2 class="section-title">Attachment</h2>
                                                <form method="POST" id="attachmentForm">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="myAction" id="Professionals_my_action"
                                                        value="insert">
                                                    <input type="hidden" name="lineNo" id="Professionals_lineNo"
                                                        value="">
                                                    <div class="row my-2">
                                                        <div class="col-md-12">
                                                            <div class="form-group" id="attachmentCodeRow">
                                                                <label class="form-label">Select Document to Upload<span
                                                                        class="text-danger">*</span></label>
                                                                <select class="form-control"
                                                                    aria-label="Default select example"
                                                                    name="attachmentCode" id="attachmentCode">
                                                                    <option class="after" value="" disabled>--Select--
                                                                    </option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="mb-2">
                                                                <label class="form-label">Upload Attachment <span
                                                                        class="text-danger">*</span></label>
                                                                <input type="file" class="form-control"
                                                                    name="attachments" id="attachments" accept=".pdf">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button type="submit"
                                                        class="btn btn-primary my-2 w-100">Upload</button>
                                                </form>

                                                <div id="AttachmentsBtns"
                                                    style="display: flex; justify-content: center;">
                                                    <button class="btn btn-secondary" id="AttachmentsPrev"><i
                                                            class="las la-angle-double-left mr-1"></i> Prev
                                                        Step</button>
                                                    <form method="post" id="payment_submit_form" style="display: none;">
                                                        {% csrf_token %}
                                                        <button class="btn btn-warning btn-icon icon-left ml-1"
                                                            id="payment_submit">Submit</button>
                                                    </form>
                                                </div>

                                            </div>
                                            <div class="row my-3" id="attachments-container">

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3" id="cert_card" style="display: none;">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Downloads</h4>
                    </div>
                    <div class="card-body">
                        <div class="money-spinner mx-auto text-center" id="spinner5" style="display: none;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                alt="Loading Gif" style="height: 70px; width: 100px;" class="img-fluid">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped data_table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Destruction Certificate</td>
                                        <td>
                                            {% if permit.Status == "Open" %}
                                            <div class="badge badge-info">{{permit.Status}}</div>
                                            {% elif permit.Status == "Processing" %}
                                            <div class="badge badge-warning">{{permit.Status}}</div>
                                            {% elif permit.Status == "Approved" %}
                                            <div class="badge badge-success">{{permit.Status}}</div>
                                            {% elif permit.Status == "Rejected" %}
                                            <div class="badge badge-danger">{{permit.Status}}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <form id="PremiseCertForm" method="post">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-info">
                                                    <i class="las la-download"></i> Download
                                                    Certificate
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3 load-hidden" style="display: none;" id="disposalDetails">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Disposal Request {{permit.DisposalNo}} Details</h4>
                    </div>
                    <div class="card-body">
                        <form action="{% url 'Disposal' %}" class="bg-white p-4" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="disposalNo" value="{{permit.DisposalNo}}">
                            <input type="hidden" name="myAction" id="myAction" value="modify">
                            <input type="hidden" name="iAgree" value="True">

                            <div class="border border-success rounded p-3 my-3">
                                <div class="row my-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Application Date</label>
                                        <input type="text" class="form-control" value="{{permit.DocumentDate}}"
                                            disabled>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Application Status</label>
                                        <input type="text" class="form-control" value="{{permit.Status}}" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="border border-success rounded p-3 my-3">
                                <p class="text-small text-primary">Disposal Information</p>
                                <div class="row my-2 gx-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Name Of The Destruction Company<span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control needs-validation"
                                            name="nameOfTheDestructionCompany" id="nameOfTheDestructionCompany"
                                            value="{{permit.NameOfTheDestructionCompany}}" disabled>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Place Of Disposal <span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="placeOfDisposal"
                                            id="placeOfDisposal" value="{{permit.Place_Of_Disposal}}" disabled>
                                    </div>
                                </div>
                                <div class="row my-2">
                                    <div class="col-md-12">
                                        <label class="form-label">Waste Description <span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="wasteDescription"
                                            id="wasteDescription" value="{{permit.Waste_Description}}" disabled>
                                    </div>
                                </div>
                                <div class="row my-2">
                                    <div class="col-md-12">
                                        <label class="form-label">Reason<span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="reason" id="reason"
                                            value="{{permit.Reason}}" disabled>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary my-3 w-100" id="edit_header" hidden>Edit
                                Form</button>
                        </form>
                    </div>
                </div>
                {% include 'alert.html' %}
            </div>
        </div>
        <div class="row mt-3" id="submitted_pros" style="display: none;">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Disposal Request Lines</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped data_table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Batch No</th>
                                        <th>Quantity </th>
                                        <th>Reason For Destruction</th>
                                        <th>Waste Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for line in lines %}
                                    <tr>
                                        <td>{{line.Product_Name}}</td>
                                        <td>{{line.BatchNo}}</td>
                                        <td>{{line.Quantity}}</td>
                                        <td>{{line.Reasons_for_Destruction_Disposition}}</td>
                                        <td>{{line.Waste_Description}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3" id="submitted_docs" style="display: none;">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Uploaded Files</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped data_table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>File Name</th>
                                        <th>File Type</th>
                                        <th>Date Attached</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attachment in attachments %}
                                    <tr>
                                        <td>{{attachment.AuxiliaryIndex2}}</td>
                                        <td>{{attachment.File_Name}}</td>
                                        <td>{{attachment.File_Type}}</td>
                                        <td id="Sub_Attached_Date{{attachment.AuxiliaryIndex2}}">
                                            {{attachment.Attached_Date}}</td>
                                        <script>
                                            $(document).ready(function () {
                                                $("#Sub_Attached_Date{{attachment.AuxiliaryIndex2}}")
                                                    .empty().append(moment(
                                                            '{{attachment.Attached_Date}}', "YYYY-MM-DD")
                                                        .format(
                                                            'Do MMM YYYY'));
                                            })
                                        </script>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>
<script>
    function showElements() {
        let disposalSteps = document.getElementById("disposalSteps")
        let disposalDetails = document.getElementById("disposalDetails")
        let spinnerPre = document.getElementById("spinnerPre")

        disposalSteps.style.display = "block"
        disposalDetails.style.display = "block"
        spinnerPre.style.display = "none"
    }

    $(document).ready(function () {

        $("#disposalSteps").on("load", showElements())
        // showElements()

        var documentStatus = '{{permit.Status}}';
        var AmountPayable = '{{permit.AmountPayable}}';
        var document_header = '{{permit.DisposalNo}}';
        var Document_Stage = '{{permit.Document_Stage}}';

        const $stepTwo = $('#stepTwo');
        const $Professionals_btn = $('#Professionals_btn');
        const $ProfessionalsNext = $('#ProfessionalsNext');
        const $ProfessionalsForm = $('#ProfessionalsForm');
        const $spinner = $('#spinner');
        const $addDisposalLine = $('#addDisposalLine')
        const $ProfessionalsTable = $('#ProfessionalsTable')
        const $hideDisposalLine = $('#hideDisposalLine')

        const $stepThree = $('#stepThree');
        const $attachmentForm = $('#attachmentForm');
        const $AttachmentsPrev = $('#AttachmentsPrev');
        const $payment_submit_form = $('#payment_submit_form');
        const $PremiseCertForm = $('#PremiseCertForm');
        const $payment_box = $('#payment_box');
        const $summary_box = $('#summary_box');
        const $edit_header = $('#edit_header');
        const $ApplicationRow = $('#ApplicationRow');
        const $submitted_pros = $('#submitted_pros');
        const $submitted_docs = $('#submitted_docs');
        const $cert_card = $('#cert_card');

        $addDisposalLine.click(() => {
            const $tablewrapper = $('#ProfessionalsTable_wrapper')
            $ProfessionalsForm.show(1000)
            $ProfessionalsTable.hide()
            // $hidePermitLine.show()
            $addDisposalLine.hide()
            $tablewrapper.hide()
        })

        $hideDisposalLine.click(() => {
            const $tablewrapper = $('#ProfessionalsTable_wrapper')
            $ProfessionalsForm.hide()
            $ProfessionalsTable.fadeIn()
            // $hidePermitLine.hide()
            $addDisposalLine.show()
            $tablewrapper.fadeIn(2000)
        })

        $('#product_disposal_status').on('change', function () {
            if (this.value === 'False') {
                $('#product_row').hide(1000);
                $('#waste_row').show(1000);
                $('#product').prop('disabled', true);
                $('#batchNo').prop('disabled', true);
                $('#Waste_Description').prop('disabled', false);
            } else if (this.value === 'True') {
                $('#product').prop('disabled', false);
                $('#batchNo').prop('disabled', false);
                $('#Waste_Description').prop('disabled', true);
                $('#product_row').show(1000);
                $('#waste_row').hide(1000);
            }
        });

        $('#reasonForDestruction').on('change', function () {
            if (this.value === '7') {
                $('#Other_Reason_Row').show(1000);
                $('#Other_Reason').prop('disabled', false);
            } else {
                $('#Other_Reason').prop('disabled', true);
                $('#Other_Reason_Row').hide(1000);
            }
        });

        if (Document_Stage === 'Not Submitted') {
            $('#nameOfTheDestructionCompany').prop('disabled', false);
            $('#placeOfDisposal').prop('disabled', false);
            $('#wasteDescription').prop('disabled', false);
            $('#reason').prop('disabled', false);
        }

        $AttachmentsPrev.click(function () {
            filter_list(document_header);
            $stepTwo.show();
            $stepThree.hide();
        })



        $ProfessionalsForm.on('submit', (e) => {
            e.preventDefault();
            if ($('#product_disposal_status').val() === '0') {
                alert('Please fill in all required fields.');
                let product_disposal_status = document.getElementById("product_disposal_status")
                product_disposal_status.style.border = "1px solid red"
                return false;
            } else if ($('#reasonForDestruction').val() === '') {
                let reasonForDestruction = document.getElementById("reasonForDestruction")
                reasonForDestruction.style.border = "1px solid red"
                return false
            } else if ($('#quantity').val() === '') {
                let quantity = document.getElementById("quantity")
                quantity.style.border = "1px solid red"
                return false
            }
            $("#spinner1").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/Disposal/' + document_header + "/",
                data: {
                    myAction: $("#Professionals_my_action").val(),
                    lineNo: $('#Professionals_lineNo').val(),
                    product_disposal_status: $('#product_disposal_status').val(),
                    batchNo: $('#batchNo').val(),
                    Waste_Description: $('#Waste_Description').val(),
                    product: $('#product').val(),
                    quantity: $('#quantity').val(),
                    Other_Reason: $('#Other_Reason').val(),
                    reasonForDestruction: $('#reasonForDestruction').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response['response']) {
                        loadProfessionals(document_header);
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Created successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });

                        $('#product_disposal_status, #batchNo, #product, #Waste_Description, #Other_Reason, #quantity')
                            .val(
                                '');
                        $('#reasonForDestruction').val('');
                    } else if (response['error']) {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response['error'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner1").hide();
                },
                error: function (error) {
                    console.log(error)
                    $("#spinner1").hide();
                }
            });
        });

        $ProfessionalsNext.click(function () {
            $stepTwo.hide();
            $stepThree.show();
            $('#other_professionals').empty().append('Upload Attachments')
        })

        $attachmentForm.on("submit", (e) => {
            e.preventDefault();
            if ($('#attachmentCode').val() === '') {
                alert('Please fill in all required fields.');
                return false;
            }
            $("#spinner3").show();
            var formData = new FormData($attachmentForm[0]);

            let attachments = $('#attachments')[0];
            var attachmentCode = $('#attachmentCode').val();

            for (let i = 0; i < attachments.files.length; i++) {
                formData.append('attachment', attachments.files[i]);
            }

            formData.append('attachmentCode', attachmentCode);

            $.ajax({
                url: "/selfservice/DisposalAttachments/" + document_header + "/",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function (data) {
                    $('#attachments').val('');
                    if (data['success'] == true) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Uploaded successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                        Load_Attachments(document_header);
                        TechnicalRequirementsData(document_header);
                    } else {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: "Upload failed: " + data,
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner3").hide();
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log(xhr.responseText);
                    $("#spinner3").hide();
                }
            });
        });


        $payment_submit_form.on('submit', (e) => {
            e.preventDefault();
            $("#spinner3").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/submit/disposal/' + document_header + "/",
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response['response']) {
                        filter_list(document_header);
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Submitted successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });

                        window.location.href = "/selfservice/dashboard";

                    } else if (response['error']) {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response['error'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner3").hide();
                },
                error: function (error) {
                    console.log(error)
                    $("#spinner3").hide();
                }
            });
        });

        $PremiseCertForm.on('submit', (e) => {
            e.preventDefault();
            $("#spinner5").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/disposal/cert/' + document_header + '/',
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                xhrFields: {
                    responseType: 'blob'
                },
                success: function (response) {
                    const blob_cert = new Blob([response], {
                        type: 'application/pdf'
                    });
                    const urls = window.URL.createObjectURL(blob_cert);

                    // Open the PDF in a new tab
                    const newTab = window.open();
                    newTab.document.open();
                    newTab.document.write('<iframe src="' + urls +
                        '" width="100%" height="100%"></iframe>');
                    newTab.document.close();

                    window.URL.revokeObjectURL(urls);

                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#0974bd',
                        icon: 'las la-check-circle',
                        title: 'Downloaded successfully',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                    $("#spinner5").hide();
                },
                error: function (error) {
                    console.log(error);
                    $("#spinner5").hide();
                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#E74C3C',
                        icon: 'las la-times-circle',
                        title: 'Error',
                        message: 'An error occurred',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                }
            });
        });



        filter_list(document_header);
        loadProfessionals(document_header);
        TechnicalRequirementsData(
            document_header);
        Load_Attachments(document_header);

        function filter_list(pk) {
            var query = '/QyDisposalRequest'
            var filter_one = 'DisposalNo'
            var filter_two = 'UserCode'


            $.ajax({
                url: "/selfservice/filter_list/" + pk,
                type: "GET",
                dataType: "json",
                data: {
                    query: query,
                    filter_one: filter_one,
                    filter_two: filter_two,
                },
                success: function (data) {
                    if (data['success'] == true) {
                        $('.document_status').empty().append(data['data']['Status']);
                        $('.Currency').empty().append(data['data']['Currency']);
                        $('.AmountPayable').empty().append(data['data']['AmountPayable']);

                        if (data['data']['Document_Stage'] === 'Not Submitted') {
                            $payment_box.show();
                            $summary_box.hide();
                            $stepTwo.show();
                            $edit_header.prop('disabled', false);
                            $edit_header.removeAttr("hidden")

                        } else if (data['data']['Document_Stage'] === 'Submitted') {
                            $edit_header.prop('disabled', true);
                            $edit_header.hide()
                            $ApplicationRow.hide();
                            $submitted_pros.show();
                            $submitted_docs.show();
                            $payment_submit_form.css('display', 'none');
                            $ProfessionalsForm.hide();
                            $attachmentForm.hide();
                            $stepTwo.hide();
                            $stepThree.hide();
                            $payment_box.hide();
                            $summary_box.show();
                            if (data['data']['Status'] === 'Approved') {
                                $cert_card.show();
                            }
                        }

                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });

        }

        function handleFormSubmission(form) {
            event.preventDefault();
            $("#spinner2").show();
            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'),
                data: form.serialize(),
                success: function (response) {
                    loadProfessionals(document_header);
                    if (response['response']) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            message: "deleted",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                    } else {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response[
                                'message'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner2").hide();
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                    iziToast.show({
                        theme: 'dark',
                        icon: 'las la-exclamation',
                        title: 'Error',
                        message: 'CSRF verification failed. Request aborted.',
                        position: 'topRight',
                        progressBarColor: '#ff0800',
                    });
                    $("#spinner2").hide();
                }
            });
        }

        function loadProfessionals(pk) {
            $.ajax({
                url: "/selfservice/DisposalLines/" + pk + "/",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var tableBody = $('#ProfessionalsTable tbody');
                    tableBody.empty(); // clear existing rows if any
                    for (var i = 0; i < data[1].length; i++) {
                        var Product_Disposal_Status = data[1][i].Product_Disposal_Status;
                        var BatchNo = data[1][i].BatchNo;
                        var product = data[1][i].Product_Name;
                        var Quantity = data[1][i].Quantity;
                        var ReasonForDestruction = data[1][i].Reasons_for_Destruction_Disposition;
                        let Line_No = data[1][i].DisposalRequestLineNo;
                        var Other_Reason_For_Destruction = data[1][i].Other_Reason_For_Destruction;
                        var Waste_Description = data[1][i].Waste_Description;

                        var row = $('<tr>');
                        if (Product_Disposal_Status === false) {
                            row.append($('<td>').text("Manufacturing waste Disposal"));
                        } else {
                            row.append($('<td>').text(product));
                        }
                        if (BatchNo === 'NONE' || BatchNo === '' || BatchNo === "None") {
                            row.append($('<td>').text('-'));
                        } else {
                            row.append($('<td>').text(BatchNo));
                        }
                        row.append($('<td>').text(Quantity));
                        if (ReasonForDestruction === 'Other') {
                            row.append($('<td>').text(Other_Reason_For_Destruction));
                        } else {
                            row.append($('<td>').text(ReasonForDestruction));
                        }
                        if (Waste_Description === 'NONE' || Waste_Description === '' ||
                            Waste_Description === "None") {
                            row.append($('<td>').text('-'));
                        } else {
                            row.append($('<td>').text(Waste_Description));
                        }
                        if (Document_Stage === 'Not Submitted') {
                            var form = $('<form>').attr({
                                method: 'POST',
                                action: '/selfservice/Disposal/' + pk + '/',
                            }).append('{% csrf_token %}');

                            var pro_batchNo = $('<input>').attr({
                                type: 'hidden',
                                name: 'batchNo',
                                value: "0"
                            });
                            var pro_product = $('<input>').attr({
                                type: 'hidden',
                                name: 'product',
                                value: "0"
                            });
                            var pro_quantity = $('<input>').attr({
                                type: 'hidden',
                                name: 'quantity',
                                value: "0"
                            });
                            var pro_reasonForDestruction = $('<input>').attr({
                                type: 'hidden',
                                name: 'reasonForDestruction',
                                value: "0"
                            });

                            var pro_Other_Reason = $('<input>').attr({
                                type: 'hidden',
                                name: 'Other_Reason',
                                value: "0"
                            });

                            var pro_Waste_Description = $('<input>').attr({
                                type: 'hidden',
                                name: 'Waste_Description',
                                value: "0"
                            });
                            var pro_product_disposal_status = $('<input>').attr({
                                type: 'hidden',
                                name: 'product_disposal_status',
                                value: "False"
                            });

                            var pro_lineNoInput = $('<input>').attr({
                                type: 'hidden',
                                name: 'lineNo',
                                value: Line_No
                            });
                            var pro_myActionInput = $('<input>').attr({
                                type: 'hidden',
                                name: 'myAction',
                                value: 'delete'
                            });
                            var pro_submitBtn = $('<button>').attr({
                                type: 'submit',
                                class: 'btn btn-danger'
                            }).text('delete');

                            // Handle form submission
                            form.submit(function (event) {
                                handleFormSubmission($(this));
                            });

                            var td = $('<td>').append(form.append(
                                pro_batchNo,
                                pro_product,
                                pro_quantity,
                                pro_reasonForDestruction, pro_myActionInput,
                                pro_lineNoInput, pro_Other_Reason, pro_Waste_Description,
                                pro_product_disposal_status,
                                pro_submitBtn));
                            row.append(td);
                        }
                        tableBody.append(row);
                    }

                    var submit_line = $('#submit_line');


                    if (tableBody.children().length > 0) {
                        submit_line.html('<i class="las la-plus"></i> Add More Lines');

                    } else if (tableBody.children().length <= 0) {
                        submit_line.text('Save');
                    }
                    // initialize DataTables for each table
                    if (!$.fn.DataTable.isDataTable('#ProfessionalsTable')) {
                        $('#ProfessionalsTable').DataTable({
                            "pageLength": 5,
                            "order": [
                                [0, "desc"]
                            ]
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }

        function TechnicalRequirementsData(pk) {
            $("#attachmentForm select[name='attachmentCode']").find('.after').nextAll().remove();
            $.ajax({
                url: "/selfservice/TechnicalRequirements/" + pk + "/",
                type: "GET",
                dataType: "json",
                data: {
                    filter: "DISPOSAL",
                    firstTimeApplication: "None",
                },
                success: function (data) {
                    if (data.length > 0) {
                        $("#AttachmentsNext").hide();
                        let options = '';
                        for (var i = 0; i < data.length; i++) {
                            const formattedDescription = data[i].Description.replace(/ /g, '_');
                            options += '<option value="' + formattedDescription + '">' + data[i]
                                .Description + '</option>';
                        }
                        $("#attachmentForm select[name='attachmentCode']").find('.after').after(
                            options);
                    } else {
                        $("#payment_submit_form").show();
                        const emptyOption =
                            '<option disabled selected>You have nothing to attach</option>';
                        $("#attachmentForm select[name='attachmentCode']").find('.after').after(
                            emptyOption);
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }

        function Load_Attachments(pk) {
            $.ajax({
                url: "/selfservice/DisposalAttachments/" + document_header + "/",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var containerDiv = $("#attachments-container");
                    containerDiv.empty(); // clear the container div
                    for (var i = 0; i < data.length; i++) {
                        (function () {
                            var docID = data[i].AuxiliaryIndex2;
                            var tableID = data[i].Table_ID;
                            var attachmentID = data[i].AuxiliaryIndex2;
                            var File_Name = data[i].File_Name;
                            var File_Extension = data[i].File_Extension;
                            // create a new div for this attachment
                            var attachmentDiv = $("<div>", {
                                class: "col-md-3"
                            });
                            var fileManBoxDiv = $("<div>", {
                                class: "file-man-box"
                            });
                            // create the form for deleting the attachment
                            if (Document_Stage === 'Not Submitted') {
                                var deleteForm = $("<form>", {
                                    method: "POST"
                                });
                                deleteForm.append($("<input>", {
                                    type: "hidden",
                                    name: "docID",
                                    value: docID
                                }));
                                deleteForm.append($("<input>", {
                                    type: "hidden",
                                    name: "tableID",
                                    value: tableID
                                }));
                                var deleteButton = $("<button>", {
                                    class: "file-close",
                                    id: "file-close",
                                    style: "background-color: white !important;"
                                }).append($("<i>", {
                                    class: "las la-times-circle",
                                }));
                                deleteButton.on("click", function (event) {
                                    event.preventDefault();
                                    $.ajax({
                                        type: 'POST',
                                        url: "/selfservice/RemovePermitAttachment/",
                                        data: {
                                            docID: docID,
                                            tableID: tableID,
                                            leaveCode: pk,
                                            csrfmiddlewaretoken: $(
                                                    'input[name=csrfmiddlewaretoken]'
                                                )
                                                .val()
                                        },
                                        success: function (data) {
                                            if (data['success'] == true) {
                                                TechnicalRequirementsData(
                                                    document_header);
                                                iziToast.show({
                                                    theme: 'dark',
                                                    backgroundColor: '#0974bd',
                                                    icon: 'las la-check-circle',
                                                    title: data[
                                                        'message'
                                                    ],
                                                    position: 'topRight',
                                                    progressBarColor: '#F4F6F7',
                                                });
                                                Load_Attachments(pk);

                                            } else {
                                                iziToast.show({
                                                    theme: 'dark',
                                                    icon: 'las la-exclamation',
                                                    title: 'Error',
                                                    message: data[
                                                        'error'
                                                    ],
                                                    position: 'topRight',
                                                    progressBarColor: '#ff0800',
                                                });
                                            }
                                        },
                                        error: function (error) {
                                            console.log(error)
                                        }
                                    });
                                });
                                fileManBoxDiv.append(deleteButton);
                            }
                            // create the div for the file icon
                            var fileImgBoxDiv = $("<div>", {
                                class: "file-img-box"
                            }).append($("<img>", {
                                src: "../../static/img/file-download.png",
                                alt: "icon"
                            }));
                            fileManBoxDiv.append(fileImgBoxDiv);
                            // create the div for the file name
                            var fileManTitleDiv = $("<div>", {
                                class: "file-man-title"
                            }).append($("<h5>", {
                                class: "mb-0 text-overflow"
                            }).text(File_Name + "." + File_Extension));
                            fileManBoxDiv.append(fileManTitleDiv);
                            attachmentDiv.append(fileManBoxDiv);
                            containerDiv.append(attachmentDiv);
                        })();
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }


    })
</script>
{% endblock %}