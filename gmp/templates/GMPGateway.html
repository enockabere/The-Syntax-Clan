{% extends 'base.html' %}
{% load static %}
{% block base %}

<!--Header-->
{% include 'navbar.html' %}
<!-- End Header -->

<!-- Sidebar-->
{% include 'sidebar.html' %}
<!-- End Sidebar -->

<main id="main" class="main">

    <div class="pagetitle">
        <h1>Payment Gateway</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item active">Payment Gateway</li>
            </ol>
        </nav>
    </div>
    <div class="row">
        <div class="col-md-12">
            {% include 'alert.html' %}
        </div>
    </div>
    <div class="container">
        <div class="row m-0">
            <div class="col-md-6 col-12">
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="row box-right">
                            <div class="col-md-8 ps-0 ">
                                <p class="ps-3 textmuted fw-bold h6 mb-0"><span class="bi bi-circle-fill pe-2"
                                        style="color:#0e5a8d;"></span> Total to Pay</p>
                                <p class="h1 fw-bold d-flex"> <span class="textmuted pe-1 h6 align-text-top mt-1">
                                        {{res.Currecy_Code}}</span>
                                    {{res.Amount_Payable}}
                                </p>
                            </div>
                            <div class="col-md-4">
                                <p class="p-blue"> Total Received</p>
                                <p class="fw-bold mb-3"><span class=" pe-1">{{res.Currecy_Code}}</span>0000<span
                                        class="textmuted">.00</span> </p>
                            </div>
                        </div>
                    </div>
                    <div class="money-spinner mx-auto text-center" id="spinner6" style="display: none;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                            alt="Loading Gif" style="height: 70px; width: 100px;" class="img-fluid">
                    </div>

                    <form id="processPayment" class="mt-3" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="Veterinary_Classes" id="Veterinary_Classes" value="GMP">
                        <input type="hidden" name="Process" id="Process" value="GMP">
                        <input type="hidden" name="Types_Of_Manufacturers" id="Types_Of_Manufacturers"
                            value="{{res.Type_Of_Manufacture}}">
                        <input type="hidden" name="bill_desc" id="bill_desc" value="GMP APPLICATION">
                        <input type="hidden" name="currency" id="bill_currency" value="{{res.Currecy_Code}}">
                        <input type="hidden" name="bill_ref_number" id="bill_ref_number" value="{{res.GMP_No_}}">
                        <input type="hidden" name="client_name" id="client_name"
                            value="{{res.Business_Registration_No_}}">
                        <input type="hidden" name="amount_expected" id="amount_expected" value="{{res.Amount_Payable}}">
                        <button type="submit" class="btn btn-primary d-block w-100"> Process Payment
                            <span class="ms-3 bi bi-arrow-right"></span>
                        </button>
                    </form>
                </div>
            </div>
            <div class="col-md-6 col-12 ps-md-5 p-0 ">
                <div class="box-left">
                    <div class="">
                        <p class="h7 fw-bold mb-1">Make Payments</p>
                        <p class="textmuted h8 mb-2">Choose from the payment options available to proceed. Your payment
                            will be processed
                            immediately.</p>
                        <form action="{% url 'FNGenerateGMPInvoice' res.GMP_No_ %}" method="post">
                            {% csrf_token %}
                            <button type='submit' class="button-87 w-100 my-3">Preview Invoice</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div id="pdfContainer" style="min-height: 600px">
                        <!-- The PDF will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

{% include 'footer.html' %}
<script>
    $(document).ready(function () {

        const $processPayment = $('#processPayment');

        $processPayment.on('submit', (e) => {
            e.preventDefault();
            $("#spinner6").show();
            $.ajax({
                type: 'POST',
                url: '/registration/PesaflowPaymentView/',
                data: {
                    bill_desc: $('#bill_desc').val(),
                    currency: $('#bill_currency').val(),
                    bill_ref_number: $('#bill_ref_number').val(),
                    client_name: $('#client_name').val(),
                    amount_expected: $('#amount_expected').val(),
                    Veterinary_Classes: $('#Veterinary_Classes').val(),
                    Types_Of_Manufacturers: $('#Types_Of_Manufacturers').val(),
                    Process: $('#Process').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {

                    console.log(response)
                    const invoiceLink = response.response_data.invoice_link;

                    const iframe = document.createElement('iframe');
                    iframe.className = 'embed-responsive-item';
                    iframe.src = invoiceLink;

                    iframe.style.width = '100%';
                    iframe.style.height = '600px';

                    const pdfContainer = document.getElementById('pdfContainer');
                    pdfContainer.style.display = 'none';

                    pdfContainer.innerHTML = '';
                    pdfContainer.appendChild(iframe);

                    $('#pdfContainer').show(1000);

                    $("#spinner6").hide();
                },
                error: function (error) {
                    console.log(error);
                    $("#spinner6").hide();
                }
            });
        });
    })
</script>
{% endblock %}