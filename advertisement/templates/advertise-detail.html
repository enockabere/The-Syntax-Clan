{% extends 'base.html' %}
{% load static %}
{% block base %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="{% static 'plugins/Moment/moment.js' %}"></script>
<link rel="stylesheet"
    href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">

<section class="section">
    <div class="section-header">
        <h1>Advertisement License</h1>
        <div class="section-header-breadcrumb">
            <div class="breadcrumb-item active"><a href="{% url 'dashboard' %}">Dashboard</a></div>
            <div class="breadcrumb-item"><a href="{% url 'MyAdverts' %}">My Applications</a></div>
            <div class="breadcrumb-item">Reference No. {{permit.AdvartisementNo}}</div>
        </div>
    </div>
    <div class="section-body">
        <div class="row" id="ApplicationRow">
            <div class="col-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4 id="other_professionals">Product Details</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div id="stepTwo" class="bg-white p-4" style="display: none">
                                    <div class="border border-success rounded p-3 my-3">
                                        <div class="premise_data" id="premise_data">
                                            <div class="money-spinner mx-auto text-center" id="spinner2"
                                                style="display: none;">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                    alt="Loading Gif" style="height: 70px; width: 100px;"
                                                    class="img-fluid">
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center my-3">
                                                <button class="btn btn-primary" id="addAdvertisementLine"><i
                                                        class="las la-plus"></i>
                                                    Add
                                                    Line</button>
                                            </div>
                                            <div class="table-responsive">
                                                <table id="ProfessionalsTable"
                                                    class="table w-100 table-striped dt-responsive table-responsive-lg table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th>Product Name</th>
                                                            <th>Target Audience </th>
                                                            <th>Uses </th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                            <td></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <form method="POST" id="ProfessionalsForm" style="display: none;">
                                                {% csrf_token %}
                                                <input type="hidden" name="myAction" id="Professionals_my_action"
                                                    value="insert">
                                                <input type="hidden" name="lineNo" id="Professionals_lineNo" value="">
                                                <div class="row my-2 gx-2">
                                                    <div class="col-md-4">
                                                        <label class="form-label">Product <span
                                                                class="text-danger">*</span></label>
                                                        <select class="form-control" aria-label="Default select example"
                                                            name="product" id="product">
                                                            <option selected disabled value="0">--Select product to
                                                                advertise--</option>
                                                            {% for product in product %}
                                                            <option value="{{product.ProductNo}}">
                                                                {{product.Productname}}
                                                            </option>
                                                            {% empty %}
                                                            <option selected disabled value="0">--You have not
                                                                registered any product--
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <label class="form-label">Target Audience<span
                                                                class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" name="targetAudience"
                                                            id="targetAudience" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="mb-2">
                                                            <label class="form-label">Uses<span
                                                                    class="text-danger">*</span></label>
                                                            <textarea class="form-control longText" name="uses"
                                                                id="uses"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="money-spinner mx-auto text-center" id="spinner1"
                                                    style="display: none;">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                        alt="Loading Gif" style="height: 100px; width: 100px;"
                                                        class="img-fluid">
                                                </div>
                                                <div class="d-flex gap-3">
                                                    <button type="submit" id='submit_line'
                                                        class="btn btn-primary mr-1 my-2 w-100">Save
                                                        Line</button>
                                                    <button type="button" class="btn btn-info my-2 ml-1 w-50"
                                                        id="hideAdvertisementLine"> <i class="las la-eye"></i> View
                                                        Lines</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="w-100">
                                        <div id="Professionals_btn" style="width: fit-content; margin: auto;">
                                            <button class="btn btn-warning" id="ProfessionalsNext">Next Step <i
                                                    class="las la-angle-double-right"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="stepThree" id="stepThree" style="display: none">
                                    <div class="m-0 bg-white p-4">
                                        <div class="Attachment_data w-100" id="Attachment_data">
                                            <div class="money-spinner mx-auto text-center" id="spinner3"
                                                style="display: none;">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                    alt="Loading Gif" style="height: 70px; width: 100px;"
                                                    class="img-fluid">
                                            </div>
                                            <h2 class="section-title">Attachment</h2>
                                            <form method="POST" id="attachmentForm">
                                                {% csrf_token %}
                                                <input type="hidden" name="myAction" id="Professionals_my_action"
                                                    value="insert">
                                                <input type="hidden" name="lineNo" id="Professionals_lineNo" value="">
                                                <div class="row my-2">
                                                    <div class="col-md-12">
                                                        <div class="form-group" id="attachmentCodeRow">
                                                            <label class="form-label">Select Document to Upload<span
                                                                    class="text-danger">*</span></label>
                                                            <select class="form-control"
                                                                aria-label="Default select example"
                                                                name="attachmentCode" id="attachmentCode">
                                                                <option class="after" value="" disabled>--Select--
                                                                </option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="mb-2">
                                                            <label class="form-label">Upload Attachment <span
                                                                    class="text-danger">*</span></label>
                                                            <input type="file" class="form-control" name="attachments"
                                                                id="attachments" accept=".pdf">
                                                        </div>
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary my-2 w-100">Upload</button>
                                            </form>

                                            <div id="AttachmentsBtns" style="width: fit-content; margin: auto;">
                                                <button class="btn btn-secondary" id="AttachmentsPrev"><i
                                                        class="las la-angle-double-left"></i> Prev
                                                    Step</button>
                                                <button class="btn btn-warning" id="AttachmentsNext"
                                                    style="display: none;">Next
                                                    Step <i class="las la-angle-double-right"></i></button>
                                            </div>
                                        </div>
                                        <div class="row my-3" id="attachments-container">

                                        </div>
                                    </div>
                                </div>
                                <div class="stepFour" id="stepFour" style="display: none">
                                    <div class="row m-0">
                                        <div class="col-md-12 bg-white my-2">
                                            <div class="d-flex justify-content-end align-items-center my-3">
                                                <div class="money-spinner mx-auto text-center" id="spinner4"
                                                    style="display: none;">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                        alt="Loading Gif" style="height: 70px; width: 100px;"
                                                        class="img-fluid">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div id="pdfContainer" style="min-height: 600px">
                                                <!-- The PDF will be displayed here -->
                                            </div>
                                            <div class="row box-right">
                                                <div class="col-md-8 ps-0 ">
                                                    <h4 class="my-3"><span id="payment_state" class="text-warning">Total
                                                            to Pay </span></h4>
                                                    <p class="h1 fw-bold d-flex"> <span
                                                            class="las la-coins textmuted pe-1 h6 align-text-top mt-2"></span>
                                                        <span class="pesa_paid">{{permit.Currency}}
                                                            {{permit.AmountPayable}}</span>
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="money-spinner mx-auto text-center" id="spinner6"
                                                style="display: none;">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                                    alt="Loading Gif" style="height: 70px; width: 100px;"
                                                    class="img-fluid">
                                            </div>
                                            <hr>
                                            <div class="text-md-right">
                                                <div class="float-lg-left mb-lg-0 mb-3">
                                                    <button class="btn btn-secondary btn-icon icon-left"
                                                        id="paymentPrev"><i class="las la-angle-double-left"></i>
                                                        Prev
                                                        Step</button>
                                                    <form method="post" id="payment_submit_form" style="display:none">
                                                        {% csrf_token %}
                                                        <button class="btn btn-warning btn-icon icon-left"
                                                            id="payment_submit">Submit
                                                        </button>
                                                    </form>
                                                </div>
                                                <form method="post" id="processPayment">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="bill_desc" id="bill_desc"
                                                        value="{{permit.FormOfAdvertisement}}">
                                                    <input type="hidden" name="currency" id="bill_currency"
                                                        value="{{permit.Currency}}">
                                                    <input type="hidden" name="bill_ref_number" id="bill_ref_number"
                                                        value="{{permit.AdvartisementNo}}">
                                                    <input type="hidden" name="client_name" id="client_name"
                                                        value="{{permit.ApplicantsName}}">
                                                    <input type="hidden" name="amount_expected" id="amount_expected"
                                                        value="{{permit.AmountPayable}}">
                                                    <input type="hidden" name="Veterinary_Classes"
                                                        id="Veterinary_Classes" value="ADVERTISING PERMIT">
                                                    <input type="hidden" name="Process" id="Process"
                                                        value="INSPECTORATE">
                                                    <input type="hidden" name="Types_Of_Manufacturers"
                                                        id="Types_Of_Manufacturers" value="Local">
                                                    <button class="btn btn-primary btn-icon icon-left"><i
                                                            class="fas fa-credit-card"></i> Process Payment</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3" id="cert_card" style="display: none;">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Downloads</h4>
                    </div>
                    <div class="card-body">
                        <div class="money-spinner mx-auto text-center" id="spinner5" style="display: none;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif"
                                alt="Loading Gif" style="height: 70px; width: 100px;" class="img-fluid">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped data_table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Advertising License</td>
                                        <td>
                                            {% if permit.Status == "Open" %}
                                            <div class="badge badge-info">{{permit.Status}}</div>
                                            {% elif permit.Status == "Processing" %}
                                            <div class="badge badge-warning">{{permit.Status}}</div>
                                            {% elif permit.Status == "Approved" %}
                                            <div class="badge badge-success">{{permit.Status}}</div>
                                            {% elif permit.Status == "Rejected" %}
                                            <div class="badge badge-danger">{{permit.Status}}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <form id="PremiseCertForm" method="post">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-info">
                                                    <i class="las la-download"></i> Download
                                                    Certificate
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Advertisement License {{permit.AdvartisementNo}} Details</h4>
                    </div>
                    <div class="card-body">
                        <form action="{% url 'advertise' %}" class="bg-white p-4" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="advertisementNo" value="{{permit.AdvartisementNo}}">
                            <input type="hidden" name="myAction" id="myAction" value="modify">
                            <input type="hidden" name="iAgree" value="True">
                            <div class="tab">
                                <div class="border border-success rounded p-3 my-3">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Application Date</label>
                                            <input type="text" class="form-control" value="{{permit.DocumentDate}}"
                                                disabled>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Amount Payable</label>
                                            <input type="text" class="form-control" value="{{permit.AmountPayable}}"
                                                disabled>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Currency</label>
                                            <input type="text" class="form-control" value="{{permit.Currency}}"
                                                disabled>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            <div class="border border-success rounded p-3 my-3">
                                <div class="row my-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Application Status</label>
                                        <input type="text" class="form-control" value="{{permit.Status}}" disabled>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Paid</label>
                                        <input type="text" class="form-control" value="{{permit.Paid}}" disabled>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-2">
                                            <label class="form-label">Form Of Advertisement<span
                                                    class="text-danger">*</span></label>
                                            <input type="text" class="form-control" name="formOfAdvertisement"
                                                id="formOfAdvertisement" value="{{permit.FormOfAdvertisement}}"
                                                disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary my-3 w-100" id="edit_header" hidden>Edit
                                Form</button>
                        </form>
                    </div>
                </div>
                {% include 'alert.html' %}
            </div>
        </div>
        <div class="row mt-3" id="submitted_pros" style="display: none;">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Advertisement License Lines</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped data_table">
                                <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Target Audience</th>
                                        <th>Uses</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for line in lines %}
                                    <tr>
                                        <td>{{line.ProductName}}</td>
                                        <td>{{line.TargetAudience}}</td>
                                        <td>{{line.Users}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3" id="submitted_docs" style="display: none;">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h4>Uploaded Files</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped data_table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>File Name</th>
                                        <th>File Type</th>
                                        <th>Date Attached</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attachment in attachments %}
                                    <tr>
                                        <td>{{attachment.AuxiliaryIndex2}}</td>
                                        <td>{{attachment.File_Name}}</td>
                                        <td>{{attachment.File_Type}}</td>
                                        <td id="Sub_Attached_Date{{attachment.AuxiliaryIndex2}}">
                                            {{attachment.Attached_Date}}</td>
                                        <script>
                                            $(document).ready(function () {
                                                $("#Sub_Attached_Date{{attachment.AuxiliaryIndex2}}")
                                                    .empty().append(moment(
                                                            '{{attachment.Attached_Date}}', "YYYY-MM-DD")
                                                        .format(
                                                            'Do MMM YYYY'));
                                            })
                                        </script>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>
<script>
    $(document).ready(function () {
        var documentStatus = '{{permit.Status}}';
        var AmountPayable = '{{permit.AmountPayable}}';
        var document_header = '{{permit.AdvartisementNo}}';
        var Invoiced = false;
        var Paid = false;
        var Document_Stage = '{{permit.Document_Stage}}';

        const $stepTwo = $('#stepTwo');
        const $Professionals_btn = $('#Professionals_btn');
        const $ProfessionalsNext = $('#ProfessionalsNext');
        const $ProfessionalsForm = $('#ProfessionalsForm');
        const $spinner = $('#spinner');
        const $addAdvertisementLine = $('#addAdvertisementLine')
        const $ProfessionalsTable = $('#ProfessionalsTable')
        const $hideAdvertisementLine = $('#hideAdvertisementLine')

        const $stepThree = $('#stepThree');
        const $FNGenerateInvoice = $('#FNGenerateInvoice');
        const $attachmentForm = $('#attachmentForm');
        const $AttachmentsPrev = $('#AttachmentsPrev');
        const $AttachmentsNext = $('#AttachmentsNext');
        const $stepFour = $('#stepFour');
        const $paymentPrev = $('#paymentPrev');
        const $payment_submit_form = $('#payment_submit_form');
        const $step5con = $('.step5con');
        const $payment_state = $('#payment_state');
        const $PremiseCertForm = $('#PremiseCertForm');
        const $payment_box = $('#payment_box');
        const $summary_box = $('#summary_box');
        const $pesa_paid = $('.pesa_paid');
        const $edit_header = $('#edit_header');
        const $ApplicationRow = $('#ApplicationRow');
        const $submitted_pros = $('#submitted_pros');
        const $submitted_docs = $('#submitted_docs');
        const $cert_card = $('#cert_card');
        const $processPayment = $('#processPayment');

        $addAdvertisementLine.click(() => {
            const $tablewrapper = $('#ProfessionalsTable_wrapper')
            $ProfessionalsForm.show(1000)
            $ProfessionalsTable.hide()
            // $hidePermitLine.show()
            $addAdvertisementLine.hide()
            $tablewrapper.hide()
        })

        $hideAdvertisementLine.click(() => {
            const $tablewrapper = $('#ProfessionalsTable_wrapper')
            $ProfessionalsForm.hide()
            $ProfessionalsTable.fadeIn()
            // $hidePermitLine.hide()
            $addAdvertisementLine.show()
            $tablewrapper.fadeIn(2000)
        })

        if (Document_Stage === 'Not Submitted') {
            $('#formOfAdvertisement').prop('disabled', false);
        }

        $AttachmentsNext.click(function () {
            $stepFour.show();
            $stepThree.hide();
            $("#other_professionals").empty().append("Payment Details")

        })

        $AttachmentsPrev.click(function () {
            filter_list(document_header);
            $stepTwo.show();
            $stepThree.hide();
        })
        $paymentPrev.click(function () {
            $stepFour.hide();
            $stepThree.show();
        })

        $ProfessionalsForm.on('submit', (e) => {
            e.preventDefault();
            if ($(
                    '#product')
                .val() === '' || $(
                    '#targetAudience')
                .val() === '' || $('#uses').val() === '') {
                alert('Please fill in all required fields.');
                return false;
            }
            $("#spinner1").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/advertise/' + document_header + "/",
                data: {
                    myAction: $("#Professionals_my_action").val(),
                    lineNo: $('#Professionals_lineNo').val(),
                    product: $('#product').val(),
                    targetAudience: $('#targetAudience').val(),
                    uses: $('#uses').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response['response']) {
                        loadProfessionals(document_header);
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Created successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });

                        $('#uses,#product, #targetAudience').val(
                            '');
                    } else if (response['error']) {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response['error'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner1").hide();
                },
                error: function (error) {
                    console.log(error)
                    $("#spinner1").hide();

                }
            });
        });

        $ProfessionalsNext.click(function () {
            if (Invoiced === false && Paid === false) {
                $("#spinner2").show();
                $.ajax({
                    type: 'POST',
                    url: '/selfservice/AdvertisingCustomer/',
                    data: {
                        advartisementNo: document_header,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function (response) {
                        if (response['response']) {
                            iziToast.show({
                                theme: 'dark',
                                backgroundColor: '#0974bd',
                                icon: 'las la-check-circle',
                                title: "Pay" + " " + AmountPayable,
                                position: 'topRight',
                                progressBarColor: '#F4F6F7',
                            });
                            $stepTwo.hide();
                            $stepThree.show();
                            $('#other_professionals').empty().append('Upload Attachments')
                        } else if (response['error']) {
                            iziToast.show({
                                theme: 'dark',
                                icon: 'las la-exclamation',
                                title: 'Error',
                                message: response['error'],
                                position: 'topRight',
                                progressBarColor: '#ff0800',
                            });
                        }
                        $("#spinner2").hide();
                    },
                    error: function (error) {
                        console.log(error)
                        $("#spinner2").hide();
                    }
                });
            } else {
                $stepTwo.hide();
                $stepThree.show();
            }
        })

        $attachmentForm.on("submit", (e) => {
            e.preventDefault();
            if ($('#attachmentCode').val() === '') {
                alert('Please fill in all required fields.');
                return false;
            }
            $("#spinner3").show();
            var formData = new FormData($attachmentForm[0]);

            let attachments = $('#attachments')[0];
            var attachmentCode = $('#attachmentCode').val();

            for (let i = 0; i < attachments.files.length; i++) {
                formData.append('attachment', attachments.files[i]);
            }

            formData.append('attachmentCode', attachmentCode);

            $.ajax({
                url: "/selfservice/AdvertAttachments/" + document_header + "/",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function (data) {
                    $('#attachments').val('');
                    if (data['success'] == true) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Uploaded successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                        Load_Attachments(document_header);
                        TechnicalRequirementsData(document_header);
                    } else {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: "Upload failed: " + data,
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner3").hide();
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log(xhr.responseText);
                    $("#spinner3").hide();
                }
            });
        });

        $processPayment.on('submit', (e) => {
            e.preventDefault();
            $("#spinner6").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/PesaflowPaymentView/',
                data: {
                    bill_desc: $('#bill_desc').val(),
                    currency: $('#bill_currency').val(),
                    bill_ref_number: $('#bill_ref_number').val(),
                    client_name: $('#client_name').val(),
                    amount_expected: $('#amount_expected').val(),
                    Veterinary_Classes: $('#Veterinary_Classes').val(),
                    Types_Of_Manufacturers: $('#Types_Of_Manufacturers').val(),
                    Process: $('#Process').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    const invoiceLink = response.response_data.invoice_link;

                    window.open(invoiceLink);

                    $("#spinner6").hide();
                },
                error: function (error) {
                    console.log(error);
                    $("#spinner6").hide();
                }
            });
        });

        $payment_submit_form.on('submit', (e) => {
            e.preventDefault();
            $("#spinner4").show();

            $.ajax({
                type: 'POST',
                url: '/selfservice/submit/advert/' + document_header + "/",
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response['response']) {
                        filter_list(document_header);
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Submitted successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });

                        window.location.href = "/selfservice/dashboard";

                    } else if (response['error']) {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response['error'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner4").hide();
                },
                error: function (error) {
                    console.log(error)
                    $("#spinner4").hide();
                }
            });
        });

        $PremiseCertForm.on('submit', (e) => {
            e.preventDefault();
            $("#spinner5").show();
            $.ajax({
                type: 'POST',
                url: '/selfservice/advert/cert/' + document_header + '/',
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                xhrFields: {
                    responseType: 'blob'
                },
                success: function (response) {

                    const blob_cert = new Blob([response], {
                        type: 'application/pdf'
                    });
                    const urls = window.URL.createObjectURL(blob_cert);

                    // Open the PDF in a new tab
                    const newTab = window.open();
                    newTab.document.open();
                    newTab.document.write('<iframe src="' + urls +
                        '" width="100%" height="100%"></iframe>');
                    newTab.document.close();

                    window.URL.revokeObjectURL(urls);

                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#0974bd',
                        icon: 'las la-check-circle',
                        title: 'Downloaded successfully',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                    $("#spinner5").hide();
                },
                error: function (error) {
                    console.log(error);
                    $("#spinner5").hide();
                    iziToast.show({
                        theme: 'dark',
                        backgroundColor: '#E74C3C',
                        icon: 'las la-times-circle',
                        title: 'Error',
                        message: 'An error occurred',
                        position: 'topRight',
                        progressBarColor: '#F4F6F7',
                    });
                }
            });
        });

        filter_list(document_header);
        loadProfessionals(document_header);
        TechnicalRequirementsData(
            document_header);
        Load_Attachments(document_header);

        function filter_list(pk) {
            var query = '/QyAdvertisement'
            var filter_one = 'AdvartisementNo'
            var filter_two = 'UserCode'


            $.ajax({
                url: "/selfservice/filter_list/" + pk,
                type: "GET",
                dataType: "json",
                data: {
                    query: query,
                    filter_one: filter_one,
                    filter_two: filter_two,
                },
                success: function (data) {
                    if (data['success'] == true) {
                        $('.document_status').empty().append(data['data']['Status']);
                        $('.Currency').empty().append(data['data']['Currency']);
                        $('.AmountPayable').empty().append(data['data']['AmountPayable']);

                        Invoiced = data['data']['Invoiced']
                        Paid = data['data']['Paid']

                        if (data['data']['Paid'] === true) {
                            $payment_submit_form.css('display', 'inline-block');
                            $payment_state.empty().append("Paid");
                            $pesa_paid.addClass('text-success');
                        }

                        if (data['data']['Document_Stage'] === 'Not Submitted') {
                            $payment_box.show();
                            $summary_box.hide();
                            $stepTwo.show();
                            $edit_header.prop('disabled', false);
                            $edit_header.removeAttr("hidden")

                            if (data['data']['Paid'] === true) {
                                $payment_box.hide();
                                $summary_box.show();
                                $processPayment.hide();
                            }
                        } else if (data['data']['Document_Stage'] === 'Submitted') {
                            $edit_header.prop('disabled', true);
                            $edit_header.hide()
                            $ApplicationRow.hide();
                            $submitted_pros.show();
                            $submitted_docs.show();
                            $payment_submit_form.css('display', 'none');
                            $ProfessionalsForm.hide();
                            $attachmentForm.hide();
                            $stepTwo.hide();
                            $stepThree.hide();
                            $stepFour.show();
                            $payment_box.hide();
                            $summary_box.show();
                            if (data['data']['Status'] === 'Approved') {
                                $cert_card.show();
                            }
                        }

                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });

        }

        function handleFormSubmission(form) {
            event.preventDefault();
            $("#spinner2").show();
            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'),
                data: form.serialize(),
                success: function (response) {
                    loadProfessionals(document_header);
                    if (response['response']) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            message: "deleted",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                    } else {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response[
                                'message'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                    $("#spinner2").hide();
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                    iziToast.show({
                        theme: 'dark',
                        icon: 'las la-exclamation',
                        title: 'Error',
                        message: 'CSRF verification failed. Request aborted.',
                        position: 'topRight',
                        progressBarColor: '#ff0800',
                    });
                    $("#spinner2").hide();
                }
            });
        }

        function loadProfessionals(pk) {
            $.ajax({
                url: "/selfservice/AdvertisementLines/" + pk + "/",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var tableBody = $('#ProfessionalsTable tbody');
                    tableBody.empty(); // clear existing rows if any
                    // iterate through the data and append to the table
                    for (var i = 0; i < data[1].length; i++) {
                        var ProductName = data[1][i].ProductName;
                        var TargetAudience = data[1][i].TargetAudience;
                        var Uses = data[1][i].Users;
                        let Line_No = data[1][i].ADVProdDNo;
                        var PremiseNo = data[1][i].AdvartisementNo;

                        var modalHtml =
                            '<div class="modal fade" tabindex="-1" role="dialog" id="edit_permit_modal' +
                            Line_No + '">' +
                            '<div class="modal-dialog modal-lg" role="document">' +
                            '<div class="modal-content">' +
                            '<div class="modal-header">' +
                            '<h5 class="modal-title">Edit Line - ' + Line_No + '</h5>' +
                            '<button type="button" class="close" data-dismiss="modal" aria-label="Close">' +
                            '<span aria-hidden="true">&times;</span>' +
                            '</button>' +
                            '</div>' +
                            '<div class="modal-body">' +
                            '<div class="money-spinner mx-auto text-center" id="line_spinner' +
                            Line_No + '" style="display: none;">' +
                            '<img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif" alt="Loading Gif" style="height: 70px; width: 70px;" class="img-fluid">' +
                            '</div>' +
                            '<form id="editLineForm' + Line_No + '">' +
                            '{% csrf_token %}' +
                            '<input type="hidden" name="PremiseNo" id="PremiseNo' + Line_No +
                            '" value="' + PremiseNo + '">' +
                            '<input type="hidden" name="lineNo" id="lineNo' + Line_No +
                            '" value="' + Line_No + '">' +
                            '<div class="row gx-2">' +
                            '<div class="col-md-6">' +
                            '<label class="form-label">Product Name <span class="text-danger">*</span></label>' +
                            '<select class="form-control" aria-label="Default select example" name="productNo" id="productNo' +
                            Line_No + '">' +
                            '</select>' +
                            '</div>' +
                            '<div class="col-md-6">' +
                            '<label class="form-label">Target Audience</label>' +
                            '<input type="text" class="form-control" name="targetAudience" id="targetAudience' +
                            Line_No + '" value=' + TargetAudience + '>' +
                            '</div>' +
                            '</div>' +
                            '<div class="row gx-2">' +
                            '<div class="col-md-12">' +
                            // Change column size to col-md-6 for better spacing
                            '<label class="form-label">Uses <span class="text-danger">*</span></label>' +
                            '<input type="text" class="form-control" name="uses" id="uses' +
                            Line_No + '" value=' + Uses + '>' +
                            '</div>' +
                            '</div>' +
                            '<button type="submit" class="btn btn-primary mr-1 my-2 w-100">Edit Line</button>' +
                            '</form>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '</div>';

                        var row = $('<tr>');
                        row.append($('<td>').text(ProductName));
                        row.append($('<td>').text(TargetAudience));
                        row.append($('<td>').text(Uses));
                        if (Document_Stage === 'Not Submitted') {
                            var form = $('<form>').attr({
                                method: 'POST',
                                action: '/selfservice/advertise/' + pk + '/',
                            }).append('{% csrf_token %}');
                            var pro_product = $('<input>').attr({
                                type: 'hidden',
                                name: 'product',
                                value: "0"
                            });
                            var pro_targetAudience = $('<input>').attr({
                                type: 'hidden',
                                name: 'targetAudience',
                                value: "0"
                            });
                            var pro_uses = $('<input>').attr({
                                type: 'hidden',
                                name: 'uses',
                                value: "0"
                            });
                            var pro_lineNoInput = $('<input>').attr({
                                type: 'hidden',
                                name: 'lineNo',
                                value: Line_No
                            });
                            var pro_myActionInput = $('<input>').attr({
                                type: 'hidden',
                                name: 'myAction',
                                value: 'delete'
                            });
                            var deleteBtn = $('<button>').attr({
                                type: 'submit',
                                class: 'btn btn-danger ml-1'
                            }).html('<i class="fas fa-trash-alt"></i>');

                            var editBtn = $('<a>').attr({
                                class: "btn btn-primary text-white",
                                type: "button",
                                "data-toggle": "modal",
                                "data-target": "#edit_permit_modal" + Line_No,
                                id: "editBtn" + Line_No,
                            }).html('<i class="fas fa-pencil-alt"></i>');

                            var buttonGroup = $('<div class="btn-group mr-2">');
                            buttonGroup.append(editBtn, deleteBtn);

                            // Handle form submission
                            form.submit(function (event) {
                                handleFormSubmission($(this));
                            });

                            var td = $('<td>').append(form.append(
                                pro_product, pro_targetAudience, pro_uses,
                                pro_lineNoInput,
                                pro_myActionInput, buttonGroup));
                            row.append(td);
                        }
                        tableBody.append(row);
                        $('body').append(modalHtml);
                    }

                    var submit_line = $('#submit_line');

                    $('body').on('click',
                        '[data-toggle="modal"][data-target^="#edit_permit_modal"]',
                        function () {
                            var modalId = $(this).attr('data-target');
                            var Line_No = modalId.replace('#edit_permit_modal', '');

                            $.ajax({
                                url: '/selfservice/GetProducts/',
                                type: 'GET',
                                dataType: 'json',
                                success: function (items) {
                                    var modal = $(modalId);

                                    var optionsHtml = '';
                                    for (var j = 0; j < items.length; j++) {
                                        optionsHtml +=
                                            `<option value="${items[j].ProductNo}">${items[j].Productname}</option>`;
                                    }
                                    modal.find('select[name="productNo"]').html(
                                        optionsHtml);
                                },
                                error: function (xhr, status, error) {
                                    console.log('Error:', error);
                                }
                            });
                        });


                    if (tableBody.children().length > 0) {
                        submit_line.html('<i class="las la-plus"></i> Add More Lines');

                    } else if (tableBody.children().length <= 0) {
                        submit_line.text('Save');
                    }


                    // initialize DataTables for each table
                    if (!$.fn.DataTable.isDataTable('#ProfessionalsTable')) {
                        $('#ProfessionalsTable').DataTable({
                            "pageLength": 5,
                            "order": [
                                [0, "desc"]
                            ]
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }

        function showSpinner(lineNo) {
            $('#line_spinner' + lineNo).show();
        }

        function hideSpinner(lineNo) {
            $('#line_spinner' + lineNo).hide();
        }

        function hideModal(lineNo) {
            $('#edit_permit_modal' + lineNo).modal('hide');
        }

        $(document).on("submit", "form[id^='editLineForm']", function (e) {
            e.preventDefault();

            // Get the CSRF token
            var csrf_token = $(this).find("[name='csrfmiddlewaretoken']").val();

            // Get the parameter values
            var myAction = "modify";
            var lineNo = $(this).find("[name='lineNo']").val();
            var productNo = $(this).find("[name='productNo']").val();
            var targetAudience = $(this).find("[name='targetAudience']").val();
            var uses = $(this).find("[name='uses']").val();
            var PremiseNo = $(this).find("[name='PremiseNo']").val();

            showSpinner(lineNo);

            $.ajax({
                url: '/selfservice/advertise/' + PremiseNo + "/",
                type: "POST",
                dataType: "json",
                data: {
                    myAction: myAction,
                    lineNo: lineNo,
                    product: productNo,
                    targetAudience: targetAudience,
                    uses: uses,
                    csrfmiddlewaretoken: csrf_token
                },
                success: function (response) {
                    hideSpinner(lineNo);
                    hideModal(lineNo);
                    loadProfessionals(PremiseNo);
                    if (response['response']) {
                        iziToast.show({
                            theme: 'dark',
                            backgroundColor: '#0974bd',
                            icon: 'las la-check-circle',
                            title: "Edited successfully",
                            position: 'topRight',
                            progressBarColor: '#F4F6F7',
                        });
                    } else if (response['error']) {
                        iziToast.show({
                            theme: 'dark',
                            icon: 'las la-exclamation',
                            title: 'Error',
                            message: response['error'],
                            position: 'topRight',
                            progressBarColor: '#ff0800',
                        });
                    }
                },
                error: function (xhr, status, error) {
                    hideSpinner(lineNo);
                    hideModal(lineNo);
                },
            });
        });

        function TechnicalRequirementsData(pk) {
            $("#attachmentForm select[name='attachmentCode']").find('.after').nextAll().remove();
            $.ajax({
                url: "/selfservice/TechnicalRequirements/" + pk + "/",
                type: "GET",
                dataType: "json",
                data: {
                    filter: "ADVERTISEMENT PERMIT",
                    firstTimeApplication: "None",
                },
                success: function (data) {
                    if (data.length > 0) {
                        $("#AttachmentsNext").hide();
                        let options = '';
                        for (var i = 0; i < data.length; i++) {
                            const formattedDescription = data[i].Description.replace(/ /g, '_');
                            options += '<option value="' + formattedDescription + '">' + data[i]
                                .Description + '</option>';
                        }
                        $("#attachmentForm select[name='attachmentCode']").find('.after').after(
                            options);
                    } else {
                        $("#AttachmentsNext").show();
                        preview_invoice(document_header);
                        const emptyOption =
                            '<option disabled selected>You have nothing to attach</option>';
                        $("#attachmentForm select[name='attachmentCode']").find('.after').after(
                            emptyOption);
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }

        function preview_invoice(pk) {
            $.ajax({
                type: 'POST',
                url: '/selfservice/AdvertisingInvoice/',
                data: {
                    advartisementNo: pk,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                xhrFields: {
                    responseType: 'blob' // Set the response type to 'blob'
                },
                success: function (response) {
                    const blob = new Blob([response], {
                        type: 'application/pdf'
                    });
                    const url = window.URL.createObjectURL(blob);

                    // Display the PDF in the iframe
                    const pdfContainer = document.getElementById('pdfContainer');
                    pdfContainer.innerHTML = '<iframe src="' + url +
                        '" width="100%" height="600"></iframe>';

                    window.URL.revokeObjectURL(url);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        function Load_Attachments(pk) {
            $.ajax({
                url: "/selfservice/AdvertAttachments/" + pk + "/",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var containerDiv = $("#attachments-container");
                    containerDiv.empty(); // clear the container div
                    for (var i = 0; i < data.length; i++) {
                        (function () {
                            if (data.length > 0) {
                                $(".step3Icon").addClass('completed');
                            }
                            var docID = data[i].AuxiliaryIndex2;
                            var tableID = data[i].Table_ID;
                            var attachmentID = data[i].AuxiliaryIndex2;
                            var File_Name = data[i].File_Name;
                            var File_Extension = data[i].File_Extension;
                            // create a new div for this attachment
                            var attachmentDiv = $("<div>", {
                                class: "col-md-3"
                            });
                            var fileManBoxDiv = $("<div>", {
                                class: "file-man-box"
                            });
                            // create the form for deleting the attachment
                            if (Document_Stage === 'Not Submitted') {
                                var deleteForm = $("<form>", {
                                    method: "POST"
                                });
                                deleteForm.append($("<input>", {
                                    type: "hidden",
                                    name: "docID",
                                    value: docID
                                }));
                                deleteForm.append($("<input>", {
                                    type: "hidden",
                                    name: "tableID",
                                    value: tableID
                                }));
                                var deleteButton = $("<button>", {
                                    class: "file-close",
                                    id: "file-close",
                                    style: "background-color: white !important;"
                                }).append($("<i>", {
                                    class: "las la-times-circle",
                                }));
                                deleteButton.on("click", function (event) {
                                    event.preventDefault();
                                    $.ajax({
                                        type: 'POST',
                                        url: "/selfservice/RemovePermitAttachment/",
                                        data: {
                                            docID: docID,
                                            tableID: tableID,
                                            leaveCode: pk,
                                            csrfmiddlewaretoken: $(
                                                    'input[name=csrfmiddlewaretoken]'
                                                )
                                                .val()
                                        },
                                        success: function (data) {
                                            if (data['success'] == true) {
                                                TechnicalRequirementsData(
                                                    document_header);
                                                iziToast.show({
                                                    theme: 'dark',
                                                    backgroundColor: '#0974bd',
                                                    icon: 'las la-check-circle',
                                                    title: data[
                                                        'message'
                                                    ],
                                                    position: 'topRight',
                                                    progressBarColor: '#F4F6F7',
                                                });
                                                Load_Attachments(pk);

                                            } else {
                                                iziToast.show({
                                                    theme: 'dark',
                                                    icon: 'las la-exclamation',
                                                    title: 'Error',
                                                    message: data[
                                                        'error'
                                                    ],
                                                    position: 'topRight',
                                                    progressBarColor: '#ff0800',
                                                });
                                            }
                                            $spinner.hide(1000);
                                        },
                                        error: function (error) {
                                            console.log(error)
                                        }
                                    });
                                });
                                fileManBoxDiv.append(deleteButton);
                            }
                            // create the div for the file icon
                            var fileImgBoxDiv = $("<div>", {
                                class: "file-img-box"
                            }).append($("<img>", {
                                src: "../../static/img/file-download.png",
                                alt: "icon"
                            }));
                            fileManBoxDiv.append(fileImgBoxDiv);
                            // create the div for the file name
                            var fileManTitleDiv = $("<div>", {
                                class: "file-man-title"
                            }).append($("<h5>", {
                                class: "mb-0 text-overflow"
                            }).text(File_Name + "." + File_Extension));
                            fileManBoxDiv.append(fileManTitleDiv);
                            attachmentDiv.append(fileManBoxDiv);
                            containerDiv.append(attachmentDiv);
                        })();
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error:", error);
                },
            });
        }

    })
</script>
{% endblock %}